                    –ú–Ü–ù–Ü–°–¢–ï–†–°–¢–í–û –û–°–í–Ü–¢–ò –Ü –ù–ê–£–ö–ò –£–ö–†–ê–á–ù–ò
   –•–ê–†–ö–Ü–í–°–¨–ö–ò–ô –ù–ê–¶–Ü–û–ù–ê–õ–¨–ù–ò–ô –£–ù–Ü–í–ï–†–°–ò–¢–ï–¢ –†–ê–î–Ü–û–ï–õ–ï–ö–¢–†–û–ù–Ü–ö–ò



                           –ö–∞—Ñ–µ–¥—Ä–∞ –ü—Ä–æ–≥—Ä–∞–º–Ω–æ—ó —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó




                                        –ó–≤—ñ—Ç
                             –∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ ‚Ññ4
                     –∑ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∏: ¬´–ê–Ω–∞–ª—ñ–∑ —Ç–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω“ë –∫–æ–¥—É¬ª
                          –∑ —Ç–µ–º–∏: ¬´–°—Ç–≤–æ—Ä–µ–Ω–Ω—è IoT –∫–ª—ñ—î–Ω—Ç–∞¬ª




–í–∏–∫–æ–Ω–∞–≤:                                                                –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤:
—Å—Ç. –≥—Ä. –ü–ó–ü–Ü-23-3                                           —Å—Ç. –≤–∏–∫–ª–∞–¥–∞—á –∫–∞—Ç–µ–¥—Ä–∏ –ü–Ü
–û—Å–∏—á–µ–Ω–∫–æ –Ü. –û.                                                       –°–æ–∫–æ—Ä—á—É–∫ –Ü. –ü.




                                   –•–∞—Ä–∫—ñ–≤ ‚Äì 2025
                                                                           2
                               1 –Ü–°–¢–û–†–Ü–Ø –ó–ú–Ü–ù

‚Ññ      –î–∞—Ç–∞    –í–µ—Ä—Å—ñ—è –∑–≤—ñ—Ç—É   –û–ø–∏—Å –∑–º—ñ–Ω —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å
1   25.12.2025     0.1        –°—Ç–≤–æ—Ä–µ–Ω–æ —Ä–æ–∑–¥—ñ–ª ¬´–ó–∞–≤–¥–∞–Ω–Ω—è¬ª
2   25.12.2025     0.2        –°—Ç–≤–æ—Ä–µ–Ω–æ —Ä–æ–∑–¥—ñ–ª ¬´–û–ø–∏—Å –≤–∏–∫–æ–Ω–∞–Ω–æ—ó —Ä–æ–±–æ—Ç–∏¬ª
3   25.12.2025     1.0        –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Ä–æ–±–æ—Ç—É –Ω–∞–¥ –∑–≤—ñ—Ç–æ–º
4   26.12.2025     1.1        –î–æ–¥–∞–Ω–æ JWT –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é, LittleFS, –∑–±—ñ–ª—å—à–µ–Ω–æ
                              –±—É—Ñ–µ—Ä –¥–æ 10K –ø–æ–¥—ñ–π



                                 2 –ó–ê–í–î–ê–ù–ù–Ø


     –†–æ–∑—Ä–æ–±–∏—Ç–∏ IoT –∫–ª—ñ—î–Ω—Ç –¥–ª—è —Å–∏—Å—Ç–µ–º–∏ BusOptima, –≤–∫–ª—é—á–∞—é—á–∏ –ø—Ä–æ–µ–∫—Ç—É–≤–∞–Ω–Ω—è
–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏, —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ —Ç–∞
–¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è, —Ñ—É–Ω–∫—Ü—ñ–π –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é —ñ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ—é
—á–∞—Å—Ç–∏–Ω–æ—é. –°—Ç–≤–æ—Ä–∏—Ç–∏ UML –¥—ñ–∞–≥—Ä–∞–º–∏ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ñ–≤ —Ç–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
—Ä–æ–±–æ—Ç–∏ IoT –∫–ª—ñ—î–Ω—Ç–∞.
                                                                                 3
                       3 –û–ü–ò–° –í–ò–ö–û–ù–ê–ù–û–á –†–û–ë–û–¢–ò

     3.1 –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ IoT –∫–ª—ñ—î–Ω—Ç–∞

     IoT –∫–ª—ñ—î–Ω—Ç —Å–∏—Å—Ç–µ–º–∏ BusOptima —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –±–∞–∑—ñ –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ ESP32
–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É Arduino. –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–±—É–¥–æ–≤–∞–Ω–∞ –∑–∞ –º–æ–¥—É–ª—å–Ω–∏–º
–ø—Ä–∏–Ω—Ü–∏–ø–æ–º –∑ —á—ñ—Ç–∫–∏–º —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è–º –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç–µ–π –º—ñ–∂ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏.
     –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É –≤–∫–ª—é—á–∞—î —Å—ñ–º –æ—Å–Ω–æ–≤–Ω–∏—Ö –º–æ–¥—É–ª—ñ–≤: config.h –º—ñ—Å—Ç–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏
–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—ñ–Ω—ñ–≤ GPIO, models.h –≤–∏–∑–Ω–∞—á–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∞–Ω–∏—Ö –¥–ª—è
–ø–æ–¥—ñ–π –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ —Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π —Ü—ñ–Ω, event_buffer.h —Ä–µ–∞–ª—ñ–∑—É—î –∫—ñ–ª—å—Ü–µ–≤–∏–π –±—É—Ñ–µ—Ä –¥–ª—è
–ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–æ–¥—ñ–π –∑ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—é —á–µ—Ä–µ–∑ LittleFS, pricing_engine.h
—ñ–Ω–∫–∞–ø—Å—É–ª—é—î –∞–ª–≥–æ—Ä–∏—Ç–º –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è, api_client.h –∑–∞–±–µ–∑–ø–µ—á—É—î HTTP-
–∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—é –∑ —Å–µ—Ä–≤–µ—Ä–æ–º, auth_manager.h –∫–µ—Ä—É—î JWT-–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é –ø—Ä–∏—Å—Ç—Ä–æ—é,
display_manager.h –∫–µ—Ä—É—î LCD-–¥–∏—Å–ø–ª–µ—î–º –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤–æ–¥—ñ—é.
     –ê–ø–∞—Ä–∞—Ç–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –≤–∫–ª—é—á–∞—î –¥–≤–∞ PIR-–¥–∞—Ç—á–∏–∫–∏ —Ä—É—Ö—É –¥–ª—è —Ñ—ñ–∫—Å–∞—Ü—ñ—ó –≤—Ö–æ–¥—É —Ç–∞
–≤–∏—Ö–æ–¥—É –ø–∞—Å–∞–∂–∏—Ä—ñ–≤, —Ç—Ä–∏ —Å–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥–∏ –¥–ª—è —ñ–Ω–¥–∏–∫–∞—Ü—ñ—ó —Å—Ç–∞–Ω—É (—Ä–æ–±–æ—Ç–∞, WiFi, –ø–æ–º–∏–ª–∫–∞), –¥–≤—ñ
–∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Ç–∞ –ø—Ä–∏–º—É—Å–æ–≤–æ—ó —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó, LCD-–¥–∏—Å–ø–ª–µ–π 16x2
–∑ I2C —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ —Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ—ó —Ü—ñ–Ω–∏.

–¢–∞–±–ª–∏—Ü—è 3.1 ‚Äì –†–æ–∑–ø–æ–¥—ñ–ª GPIO –ø—ñ–Ω—ñ–≤ ESP32
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç    GPIO     –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
PIR Entry    GPIO14   –î–∞—Ç—á–∏–∫ –≤—Ö–æ–¥—É –ø–∞—Å–∞–∂–∏—Ä—ñ–≤
PIR Exit     GPIO12   –î–∞—Ç—á–∏–∫ –≤–∏—Ö–æ–¥—É –ø–∞—Å–∞–∂–∏—Ä—ñ–≤
LED Status   GPIO25   –Ü–Ω–¥–∏–∫–∞—Ü—ñ—è —Ä–æ–±–æ—Ç–∏
LED WiFi     GPIO26   –°—Ç–∞–Ω WiFi –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è
LED Error    GPIO27   –Ü–Ω–¥–∏–∫–∞—Ü—ñ—è –ø–æ–º–∏–ª–æ–∫
BTN Reset    GPIO4    –°–∫–∏–¥–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
BTN Sync     GPIO5    –ü—Ä–∏–º—É—Å–æ–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
LCD SDA      GPIO21   I2C –¥–∞–Ω—ñ –¥–∏—Å–ø–ª–µ—è
LCD SCL      GPIO22   I2C —Ç–∞–∫—Ç—É–≤–∞–Ω–Ω—è –¥–∏—Å–ø–ª–µ—è

     3.2 UML –¥—ñ–∞–≥—Ä–∞–º–∞ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ñ–≤

     –î—ñ–∞–≥—Ä–∞–º–∞ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ñ–≤ –æ–ø–∏—Å—É—î –æ—Å–Ω–æ–≤–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó –∞–∫—Ç–æ—Ä—ñ–≤ –∑ IoT
–∫–ª—ñ—î–Ω—Ç–æ–º. –°–∏—Å—Ç–µ–º–∞ –º–∞—î —á–æ—Ç–∏—Ä–∏ –∞–∫—Ç–æ—Ä–∏: IoT-–ø—Ä–∏—Å—Ç—Ä—ñ–π —è–∫ –≥–æ–ª–æ–≤–Ω–∏–π –≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å –±—ñ–∑–Ω–µ—Å-
                                                                             4
–ª–æ–≥—ñ–∫–∏, —Å–µ—Ä–≤–µ—Ä BusOptima –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö, –¥–∞—Ç—á–∏–∫–∏ —Ä—É—Ö—É —è–∫ –¥–∂–µ—Ä–µ–ª–æ –ø–æ–¥—ñ–π
–ø–∞—Å–∞–∂–∏—Ä—ñ–≤, –≤–æ–¥—ñ–π –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.
     –û—Å–Ω–æ–≤–Ω—ñ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–∏ (–¥–∏–≤. —Ä–∏—Å. 3.1) –≤–∫–ª—é—á–∞—é—Ç—å –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ –∑
—Ñ—ñ–∫—Å–∞—Ü—ñ—î—é –≤—Ö–æ–¥—É —Ç–∞ –≤–∏—Ö–æ–¥—É —á–µ—Ä–µ–∑ PIR-–¥–∞—Ç—á–∏–∫–∏, –¥–∏–Ω–∞–º—ñ—á–Ω–µ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑
—Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–º —Ç—Ä—å–æ—Ö –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –¥–∞–Ω–∏—Ö –∑ —Å–µ—Ä–≤–µ—Ä–æ–º —á–µ—Ä–µ–∑ REST API,
–ª–æ–∫–∞–ª—å–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–æ–¥—ñ–π —É –∫—ñ–ª—å—Ü–µ–≤–æ–º—É –±—É—Ñ–µ—Ä—ñ –∑ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—é, –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
–ø—Ä–∏—Å—Ç—Ä–æ—é —á–µ—Ä–µ–∑ —Ñ—ñ–∑–∏—á–Ω—ñ –∫–Ω–æ–ø–∫–∏, –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –Ω–∞ LCD-–¥–∏—Å–ø–ª–µ—ó.




              –†–∏—Å—É–Ω–æ–∫ 3.1 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ñ–≤ IoT –∫–ª—ñ—î–Ω—Ç–∞
                                                                                  5
     3.3 –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ IoT –∫–ª—ñ—î–Ω—Ç–∞

     3.3.1 –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤

     –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ –¥–≤–∞ PIR-–¥–∞—Ç—á–∏–∫–∏ —Ä—É—Ö—É, –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ
–Ω–∞ –≤—Ö–æ–¥—ñ –≤ –∞–≤—Ç–æ–±—É—Å. –î–∞—Ç—á–∏–∫ –≤—Ö–æ–¥—É (PIR Entry) —Ñ—ñ–∫—Å—É—î —Ä—É—Ö —É –Ω–∞–ø—Ä—è–º–∫—É —Å–∞–ª–æ–Ω—É, –¥–∞—Ç—á–∏–∫
–≤–∏—Ö–æ–¥—É (PIR Exit) —Ñ—ñ–∫—Å—É—î —Ä—É—Ö —É –∑–≤–æ—Ä–æ—Ç–Ω–æ–º—É –Ω–∞–ø—Ä—è–º–∫—É. –û–±—Ä–æ–±–∫–∞ —Å–∏–≥–Ω–∞–ª—ñ–≤ –¥–∞—Ç—á–∏–∫—ñ–≤
–≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –∞–ø–∞—Ä–∞—Ç–Ω—ñ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è GPIO –¥–ª—è –º–∏—Ç—Ç—î–≤–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó –Ω–∞ –ø–æ–¥—ñ—ó.
     –ú–µ—Ö–∞–Ω—ñ–∑–º debounce –∑–∞–ø–æ–±—ñ–≥–∞—î —Ö–∏–±–Ω–∏–º —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è–º: –ø–æ–≤—Ç–æ—Ä–Ω–∞ –ø–æ–¥—ñ—è –≤—ñ–¥
—Ç–æ–≥–æ –∂ –¥–∞—Ç—á–∏–∫–∞ —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º 500 –º—Å –ø—ñ—Å–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó. –ö–æ–∂–Ω–∞ –ø–æ–¥—ñ—è
–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É –ª–æ–∫–∞–ª—å–Ω–æ–º—É –±—É—Ñ–µ—Ä—ñ –∑ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–æ–º, –º—ñ—Ç–∫–æ—é —á–∞—Å—É, GPS-
–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ —Ç–∞ –ø–æ—Ç–æ—á–Ω–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ –ø—ñ—Å–ª—è –ø–æ–¥—ñ—ó.

     3.3.2 –ê–ª–≥–æ—Ä–∏—Ç–º –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è

     IoT-–ø—Ä–∏—Å—Ç—Ä—ñ–π –≤–∏–∫–æ–Ω—É—î –ª–æ–∫–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ—ó —Ü—ñ–Ω–∏ –∫–æ–∂–Ω—ñ 5
—Ö–≤–∏–ª–∏–Ω –∑–∞ —Ñ–æ—Ä–º—É–ª–æ—é:
                         ùëÉ—Ä–µ–∫ = ùëÉ–±–∞–∑ √ó ùêæ–ø–æ–ø–∏—Ç √ó ùêæ—á–∞—Å √ó ùêæ–¥–µ–Ω—å                   (3.1)

     –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –ø–æ–ø–∏—Ç—É ùêæ–ø–æ–ø–∏—Ç –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–æ—á–Ω–æ—ó –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ—Å—Ç—ñ
–∞–≤—Ç–æ–±—É—Å–∞:
                          0.75   —è–∫—â–æ   –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å < 30%
                          0.95   —è–∫—â–æ   30% ‚â§ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å < 60%
              ùêæ–ø–æ–ø–∏—Ç   =                                                       (3.2)
                          1.10   —è–∫—â–æ   60% ‚â§ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å < 85%
                         {1.40   —è–∫—â–æ   –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å ‚â• 85%

     –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —á–∞—Å—É ùêæ—á–∞—Å –≤—Ä–∞—Ö–æ–≤—É—î –ø—ñ–∫–æ–≤—ñ –≥–æ–¥–∏–Ω–∏ —Ä—É—Ö—É:
                      1.20 —è–∫—â–æ ùë° ‚àà [7 : 00, 9 : 00] ‚à™ [17 : 00, 19 : 00]
             ùêæ—á–∞—Å   = 0.80 —è–∫—â–æ ùë° ‚àà [23 : 00, 6 : 00]                          (3.3)
                     {1.00 –≤ —ñ–Ω—à–∏–π —á–∞—Å
     –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –¥–Ω—è ùêæ–¥–µ–Ω—å : 1.15 —É –≤–∏—Ö—ñ–¥–Ω—ñ —Ç–∞ —Å–≤—è—Ç–∫–æ–≤—ñ –¥–Ω—ñ, 1.00 —É –±—É–¥–Ω—ñ.
     –§—ñ–Ω–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞ –æ–±–º–µ–∂—É—î—Ç—å—Å—è –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º [0.7 √ó ùëÉ–±–∞–∑ , 1.5 √ó ùëÉ–±–∞–∑ ] —Ç–∞ –æ–∫—Ä—É–≥–ª—é—î—Ç—å—Å—è
–¥–æ –Ω–∞–π–±–ª–∏–∂—á–∏—Ö 5 –≥—Ä–Ω –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤.
                                                                                6
      3.3.3 –õ–æ–∫–∞–ª—å–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–æ–¥—ñ–π

      –ö—ñ–ª—å—Ü–µ–≤–∏–π –±—É—Ñ–µ—Ä EventBuffer –∑–∞–±–µ–∑–ø–µ—á—É—î –Ω–∞–¥—ñ–π–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–æ 10,000 –ø–æ–¥—ñ–π
–ø–∞—Å–∞–∂–∏—Ä—ñ–≤ –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —Ç–∏–∂–Ω–µ–≤–æ—ó –∞–≤—Ç–æ–Ω–æ–º—ñ—ó —Ä–æ–±–æ—Ç–∏. –ü—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-
–∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –ø–æ–¥—ñ—ó –Ω–∞–∫–æ–ø–∏—á—É—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—é—Ç—å—Å—è –ø—Ä–∏
–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—ñ –∑–≤‚Äô—è–∑–∫—É. –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª–æ–≤—É —Å–∏—Å—Ç–µ–º—É LittleFS,
—â–æ –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–¥—ñ—ó —É –±—ñ–Ω–∞—Ä–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ –≤ —Ñ–∞–π–ª—ñ ¬´/events.dat¬ª —Ç–∞ –º–µ—Ç–∞–¥–∞–Ω—ñ –≤ ¬´/
config.dat¬ª .
      –ë—É—Ñ–µ—Ä –ø—ñ–¥—Ç—Ä–∏–º—É—î –æ–ø–µ—Ä–∞—Ü—ñ—ó: –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó –ø–æ–¥—ñ—ó –∑ –∞–≤—Ç–æ—ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–º localId,
–≤–∏–±—ñ—Ä–∫–∞ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏—Ö –ø–æ–¥—ñ–π –ø–∞–∫–µ—Ç–∞–º–∏ –ø–æ 100 –∑–∞–ø–∏—Å—ñ–≤, –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ–¥—ñ–π —è–∫
—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏—Ö –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∫–æ–º–ø–∞–∫—Ç—É–≤–∞–Ω–Ω—è
–ø—Ä–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—ñ –±—ñ–ª—å—à–µ 80%, –ø–æ–≤–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ —Å–∫–∏–¥–∞–Ω–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å.

      3.4 UML –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ

      –î—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ (–¥–∏–≤. —Ä–∏—Å. –ë2) –æ–ø–∏—Å—É—î –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –¥—ñ–π –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ
–ø–æ–¥—ñ—ó –ø–∞—Å–∞–∂–∏—Ä–∞. –ü—Ä–æ—Ü–µ—Å –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑—ñ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è PIR-–¥–∞—Ç—á–∏–∫–∞, —â–æ –≥–µ–Ω–µ—Ä—É—î
–∞–ø–∞—Ä–∞—Ç–Ω–µ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è. –û–±—Ä–æ–±–Ω–∏–∫ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä—è—î debounce-—ñ–Ω—Ç–µ—Ä–≤–∞–ª —Ç–∞
–≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –ø—Ä–∞–ø–æ—Ä–µ—Ü—å –ø–æ–¥—ñ—ó. –£ –≥–æ–ª–æ–≤–Ω–æ–º—É —Ü–∏–∫–ª—ñ –ø—Ä–æ–≥—Ä–∞–º–∏ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è,
–≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è —Ç–∏–ø –ø–æ–¥—ñ—ó (–≤—Ö—ñ–¥/–≤–∏—Ö—ñ–¥), –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤, —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è
–æ–±‚Äô—î–∫—Ç PassengerEvent –∑ —É—Å—ñ–º–∞ –º–µ—Ç–∞–¥–∞–Ω–∏–º–∏, –ø–æ–¥—ñ—è –¥–æ–¥–∞—î—Ç—å—Å—è –¥–æ –±—É—Ñ–µ—Ä–∞, –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è
LCD-–¥–∏—Å–ø–ª–µ–π —Ç–∞ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ª–æ–≥—É–≤–∞–Ω–Ω—è.
      –î—Ä—É–≥–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ (–¥–∏–≤. —Ä–∏—Å. –ë3) –æ–ø–∏—Å—É—î –ø—Ä–æ—Ü–µ—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ
–¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è. –¢–∞–π–º–µ—Ä –∑–∞–ø—É—Å–∫–∞—î —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω. –°–∏—Å—Ç–µ–º–∞
–∑–±–∏—Ä–∞—î –≤—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ: –±–∞–∑–æ–≤—É —Ü—ñ–Ω—É –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ä–µ–π—Å—É, –ø–æ—Ç–æ—á–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–∞—Å–∞–∂–∏—Ä—ñ–≤,
–º—ñ—Å—Ç–∫—ñ—Å—Ç—å –∞–≤—Ç–æ–±—É—Å–∞ —Ç–∞ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å. –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è —Ç—Ä–∏ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏
–Ω–∞ –æ—Å–Ω–æ–≤—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ—Å—Ç—ñ, –≥–æ–¥–∏–Ω–∏ –¥–æ–±–∏ —Ç–∞ –¥–Ω—è —Ç–∏–∂–Ω—è. –û–±—á–∏—Å–ª—é—î—Ç—å—Å—è —Å–∏—Ä–∞ —Ü—ñ–Ω–∞,
–∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –æ–±–º–µ–∂–µ–Ω–Ω—è –¥—ñ–∞–ø–∞–∑–æ–Ω—É —Ç–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –Ω–∞
—Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ HTTP POST –∑–∞–ø–∏—Ç.
                                                                               7
      3.5 –§—É–Ω–∫—Ü—ñ—ó –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è IoT –∫–ª—ñ—î–Ω—Ç–∞

      3.5.1 –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ –±–µ–∑–ø–µ–∫–∞

      IoT –ø—Ä–∏—Å—Ç—Ä—ñ–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î JWT-—Ç–æ–∫–µ–Ω–∏ –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–∏
–ø–µ—Ä—à–æ–º—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ –ø—Ä–∏—Å—Ç—Ä—ñ–π –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î POST –∑–∞–ø–∏—Ç –¥–æ ¬´/api/auth/device¬ª –∑
—Å–µ—Ä—ñ–π–Ω–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–∞ —Å–µ–∫—Ä–µ—Ç–Ω–∏–º —Ç–æ–∫–µ–Ω–æ–º. –°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î JWT access token –∑
—Ç–µ—Ä–º—ñ–Ω–æ–º –¥—ñ—ó, —è–∫–∏–π –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É —Ñ–∞–π–ª—ñ ¬´/auth_token.dat¬ª —á–µ—Ä–µ–∑ LittleFS.
      AuthManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–µ—Ä—É—î –∂–∏—Ç—Ç—î–≤–∏–º —Ü–∏–∫–ª–æ–º —Ç–æ–∫–µ–Ω—ñ–≤: –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ç–µ—Ä–º—ñ–Ω
–¥—ñ—ó –ø–µ—Ä–µ–¥ –∫–æ–∂–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î —Ç–æ–∫–µ–Ω–∏ –∑–∞ 5 —Ö–≤–∏–ª–∏–Ω –¥–æ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è,
–∑–±–µ—Ä—ñ–≥–∞—î —Ç–æ–∫–µ–Ω–∏ –º—ñ–∂ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º–∏ –ø—Ä–∏—Å—Ç—Ä–æ—é, –æ—á–∏—â—É—î –Ω–µ–¥—ñ–π—Å–Ω—ñ —Ç–æ–∫–µ–Ω–∏ –ø—Ä–∏
–ø–æ–º–∏–ª–∫–∞—Ö –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.
      –í—Å—ñ HTTP –∑–∞–ø–∏—Ç–∏ –¥–æ API –≤–∫–ª—é—á–∞—é—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ ¬´Authorization: Bearer <token>¬ª
–¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—Ä–∏—Å—Ç—Ä–æ—é —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É.

      3.5.2 –ê–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ä–µ–∂–∏–º —Ä–æ–±–æ—Ç–∏

      IoT –ø—Ä–∏—Å—Ç—Ä—ñ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–º–∏–∫–∞—î—Ç—å—Å—è –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ä–µ–∂–∏–º –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ
–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∞–±–æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é. –í –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ
–ø—Ä–∏—Å—Ç—Ä—ñ–π –ø—Ä–æ–¥–æ–≤–∂—É—î –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –≤—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:
      ‚Äì   –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ —á–µ—Ä–µ–∑ PIR-–¥–∞—Ç—á–∏–∫–∏ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω–∏–º
      ‚Äì   –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–∏–Ω–∞–º—ñ—á–Ω–æ—ó —Ü—ñ–Ω–∏ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–∞ —Ç–∏–º –∂–µ
          –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º
      ‚Äì   –í—Å—ñ –ø–æ–¥—ñ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –±—É—Ñ–µ—Ä—ñ –¥–æ 10,000 –∑–∞–ø–∏—Å—ñ–≤
      ‚Äì   LCD-–¥–∏—Å–ø–ª–µ–π –ø–æ–∫–∞–∑—É—î –ø–æ—Ç–æ—á–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º —Ä–µ–∂–∏–º—É [O]
      –ü—Ä–∏ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –ø—Ä–∏—Å—Ç—Ä—ñ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –≤ –æ–Ω–ª–∞–π–Ω
—Ä–µ–∂–∏–º —Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î –≤—Å—ñ –Ω–∞–∫–æ–ø–∏—á–µ–Ω—ñ –ø–æ–¥—ñ—ó –∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –¶–µ –∑–∞–±–µ–∑–ø–µ—á—É—î –±–µ–∑–ø–µ—Ä–µ—Ä–≤–Ω—É
—Ä–æ–±–æ—Ç—É —Å–∏—Å—Ç–µ–º–∏ –Ω–∞–≤—ñ—Ç—å –ø—Ä–∏ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–æ–º—É —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑‚Äô—î–¥–Ω–∞–Ω–Ω—ñ.

      3.5.3 –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –º–µ—Ä–µ–∂—ñ

      WiFi-–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –ø—Ä–∏—Å—Ç—Ä–æ—é –∑ —Ç–∞–π–º–∞—É—Ç–æ–º 10 —Å–µ–∫—É–Ω–¥.
–ü—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–æ–Ω—É—î –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 5
—Å–µ–∫—É–Ω–¥. –°—Ç–∞–Ω WiFi —ñ–Ω–¥–∏–∫—É—î—Ç—å—Å—è —Å–∏–Ω—ñ–º —Å–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥–æ–º.
                                                                               8
     –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —á–∞—Å—É –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ NTP-—Å–µ—Ä–≤–µ—Ä–∏ (pool.ntp.org) –¥–ª—è
–∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ —á–∞—Å—É —Ç–∞ –¥–Ω—è. –ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –Ω–∞
UTC+2 (–ö–∏—ó–≤).

     3.5.4 –°–∫–∏–¥–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å

     –ö–Ω–æ–ø–∫–∞ Reset (GPIO4) –¥–æ–∑–≤–æ–ª—è—î —Å–∫–∏–Ω—É—Ç–∏ –ø—Ä–∏—Å—Ç—Ä—ñ–π –¥–æ –∑–∞–≤–æ–¥—Å—å–∫–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å.
–ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –æ—á–∏—â—É—î—Ç—å—Å—è –±—É—Ñ–µ—Ä –ø–æ–¥—ñ–π, —Å–∫–∏–¥–∞—é—Ç—å—Å—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤,
–≤—ñ–¥–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–ª—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ä–µ–π—Å—É. –û–ø–µ—Ä–∞—Ü—ñ—è
–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î—Ç—å—Å—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º –Ω–∞ LCD-–¥–∏—Å–ø–ª–µ—ó.

     3.5.5 –ü—Ä–∏–º—É—Å–æ–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è

     –ö–Ω–æ–ø–∫–∞ Sync (GPIO5) —ñ–Ω—ñ—Ü—ñ—é—î –Ω–µ–≥–∞–π–Ω—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –Ω–∞–∫–æ–ø–∏—á–µ–Ω–∏—Ö –ø–æ–¥—ñ–π –∑
—Å–µ—Ä–≤–µ—Ä–æ–º, –Ω–µ —á–µ–∫–∞—é—á–∏ –ø–ª–∞–Ω–æ–≤–æ–≥–æ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É –≤ 5 —Ö–≤–∏–ª–∏–Ω. –ö–æ—Ä–∏—Å–Ω–æ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ
—Ä–µ–π—Å—É –∞–±–æ –ø–µ—Ä–µ–¥ –≤–∏–º–∫–Ω–µ–Ω–Ω—è–º –ø—Ä–∏—Å—Ç—Ä–æ—é.

–¢–∞–±–ª–∏—Ü—è 3.2 ‚Äì –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ IoT –∫–ª—ñ—î–Ω—Ç–∞
–ü–∞—Ä–∞–º–µ—Ç—Ä                          –û–ø–∏—Å                             –ó–Ω–∞—á–µ–Ω–Ω—è
SYNC_INTERVAL_MS                  –Ü–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó       300000 (5 —Ö–≤)
PRICE_CALC_INTERVAL_MS            –Ü–Ω—Ç–µ—Ä–≤–∞–ª —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω–∏         300000 (5 —Ö–≤)
SENSOR_DEBOUNCE_MS                Debounce –¥–∞—Ç—á–∏–∫—ñ–≤                500
MAX_EVENTS_BUFFER                 –†–æ–∑–º—ñ—Ä –±—É—Ñ–µ—Ä–∞ –ø–æ–¥—ñ–π              10000
EVENTS_BATCH_SIZE                 –†–æ–∑–º—ñ—Ä –ø–∞–∫–µ—Ç—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó      100
WIFI_CONNECT_TIMEOUT_MS           –¢–∞–π–º–∞—É—Ç WiFi                     10000

     3.6 –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è —ñ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ—é —á–∞—Å—Ç–∏–Ω–æ—é

     3.6.1 REST API –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏

     IoT –∫–ª—ñ—î–Ω—Ç –≤–∑–∞—î–º–æ–¥—ñ—î –∑ —Å–µ—Ä–≤–µ—Ä–æ–º —á–µ—Ä–µ–∑ —Ç—Ä–∏ –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏:
     POST /api/auth/device - –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø—Ä–∏—Å—Ç—Ä–æ—é. –ó–∞–ø–∏—Ç –º—ñ—Å—Ç–∏—Ç—å serial_number
—Ç–∞ token –ø—Ä–∏—Å—Ç—Ä–æ—é. –í—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ–≤–µ—Ä—Ç–∞—î access_token, device_id —Ç–∞ expires_in –¥–ª—è
–ø–æ–¥–∞–ª—å—à–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤.
     POST /api/iot/events - —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –ø–æ–¥—ñ–π –ø–∞—Å–∞–∂–∏—Ä—ñ–≤. –ó–∞–ø–∏—Ç –º—ñ—Å—Ç–∏—Ç—å trip_id
—Ç–∞ –º–∞—Å–∏–≤ –ø–æ–¥—ñ–π –∑ –ø–æ–ª—è–º–∏ local_id, event_type, timestamp, latitude, longitude,
                                                                                     9
passenger_count_after. –í—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ–≤–µ—Ä—Ç–∞—î synced_count, last_synced_local_id —Ç–∞
server_time.
        POST /api/iot/price - –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —Ü—ñ–Ω–∏. –ó–∞–ø–∏—Ç –º—ñ—Å—Ç–∏—Ç—å trip_id,
base_price, recommended_price, occupancy_rate —Ç–∞ —Ç—Ä–∏ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏. –°–µ—Ä–≤–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—î
—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—é –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏.
        GET /api/iot/config/{tripId} - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ä–µ–π—Å—É. –í—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å
trip_id, route_id, bus_capacity —Ç–∞ base_price –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ª–æ–∫–∞–ª—å–Ω–∏—Ö —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤.

        3.6.2 –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è

        –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ JWT-—Ç–æ–∫–µ–Ω –ø—Ä–∏—Å—Ç—Ä–æ—é –∑ –¥–≤–æ–µ—Ç–∞–ø–Ω–∏–º
–ø—Ä–æ—Ü–µ—Å–æ–º. –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏—Å—Ç—Ä—ñ–π –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î POST –∑–∞–ø–∏—Ç –¥–æ ¬´/api/auth/device¬ª –∑ JSON-
—Ç—ñ–ª–æ–º, —â–æ –º—ñ—Å—Ç–∏—Ç—å ¬´serial_number¬ª —Ç–∞ ¬´token¬ª –ø—Ä–∏—Å—Ç—Ä–æ—é. –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä—è—î –æ–±–ª—ñ–∫–æ–≤—ñ
–¥–∞–Ω—ñ —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î JWT access token –∑ ¬´device_id¬ª , ¬´expires_in¬ª —Ç–∞ —Å–∞–º–∏–º —Ç–æ–∫–µ–Ω–æ–º.
        –û—Ç—Ä–∏–º–∞–Ω–∏–π —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è —É –∑–∞–≥–æ–ª–æ–≤–∫—É ¬´Authorization: Bearer <token>¬ª
–¥–ª—è –≤—Å—ñ—Ö –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö API –∑–∞–ø–∏—Ç—ñ–≤. –¢–æ–∫–µ–Ω –º—ñ—Å—Ç–∏—Ç—å device_id, serial_number —Ç–∞ —Ç–∏–ø
¬´device¬ª, —â–æ –¥–æ–∑–≤–æ–ª—è—î —Å–µ—Ä–≤–µ—Ä—É —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –ø—Ä–∏—Å—Ç—Ä—ñ–π —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ
–ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É.
        AuthManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–µ—Ä—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º —Ç–æ–∫–µ–Ω—ñ–≤ —Ç–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ—é
–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –ø–æ–º–∏–ª–æ–∫ –∑ –∫–æ–¥–æ–º 401.

        3.6.3 –§–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö

        –û–±–º—ñ–Ω –¥–∞–Ω–∏–º–∏ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON. –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ ArduinoJson
–∑–∞–±–µ–∑–ø–µ—á—É—î —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é —Ç–∞ –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –∑ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–º —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è–º –ø–∞–º‚Äô—è—Ç—ñ.
–ß–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —É —Ñ–æ—Ä–º–∞—Ç—ñ RFC3339 (ISO 8601).
        –ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Ç—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:

1   POST /api/auth/device
2   {
3       "serial_number": "IOT001",
4       "token": "device_token_123"
5   }


        –ü—Ä–∏–∫–ª–∞–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:

1   {
                                                                                10

2        "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
3        "device_id": 1,
4        "expires_in": 360000
5   }


        –ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Ç—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –ø–æ–¥—ñ–π:

 1 {
 2        "trip_id": 1,
 3        "events": [
 4            {
 5                "local_id": 1,
 6                "event_type": "entry",
 7                "timestamp": "2025-12-25T08:15:00Z",
 8                "latitude": 49.9935,
 9                "longitude": 36.2304,
10                "passenger_count_after": 15
11            }
12        ]
13 }


        –ü—Ä–∏–∫–ª–∞–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–µ—Ä–≤–µ—Ä–∞:

1   {
2        "synced_count": 1,
3        "last_synced_local_id": 1,
4        "trip_current_passengers": 15,
5        "server_time": "2025-12-25T08:15:05Z"
6   }


        3.7 –°–∏–º—É–ª—è—Ü—ñ—è —Ç–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

        –î–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏ —Ç–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å–∏–º—É–ª—è—Ç–æ—Ä Wokwi, —â–æ –¥–æ–∑–≤–æ–ª—è—î
–µ–º—É–ª—é–≤–∞—Ç–∏ ESP32 –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–º–∏ –ø–µ—Ä–∏—Ñ–µ—Ä—ñ–π–Ω–∏–º–∏ –ø—Ä–∏—Å—Ç—Ä–æ—è–º–∏ –±–µ–∑ —Ñ—ñ–∑–∏—á–Ω–æ–≥–æ
–æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è. –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ –æ–ø–∏—Å–∞–Ω–∞ —É —Ñ–∞–π–ª–∞—Ö diagram.json (—Å—Ö–µ–º–∞
–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤) —Ç–∞ wokwi.toml (–Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏ —Ç–∞ –º–µ—Ä–µ–∂—ñ).
        –°–∏–º—É–ª—è—Ü—ñ—è –≤–∫–ª—é—á–∞—î: ESP32 DevKit C V4 —è–∫ –æ—Å–Ω–æ–≤–Ω–∏–π –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä, –¥–≤–∞
PIR-–¥–∞—Ç—á–∏–∫–∏ —Ä—É—Ö—É –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –≤—Ö–æ–¥—É/–≤–∏—Ö–æ–¥—É –ø–∞—Å–∞–∂–∏—Ä—ñ–≤, —Ç—Ä–∏ —Å–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥–∏ –¥–ª—è —ñ–Ω–¥–∏–∫–∞—Ü—ñ—ó
—Å—Ç–∞–Ω—É, –¥–≤—ñ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, LCD-–¥–∏—Å–ø–ª–µ–π 16x2 –∑ I2C
–¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.
        Wokwi IoT Gateway –∑–∞–±–µ–∑–ø–µ—á—É—î –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ WiFi-–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∏–º—É–ª—å–æ–≤–∞–Ω–æ–≥–æ
ESP32 –¥–æ –ª–æ–∫–∞–ª—å–Ω–æ—ó –º–µ—Ä–µ–∂—ñ, —â–æ –¥–æ–∑–≤–æ–ª—è—î —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ HTTP-–∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—é –∑ —Ä–µ–∞–ª—å–Ω–∏–º
—Å–µ—Ä–≤–µ—Ä–æ–º.
                                                                               11
                                  –í–ò–°–ù–û–í–ö–ò


     –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–æ IoT –∫–ª—ñ—î–Ω—Ç –¥–ª—è
—Å–∏—Å—Ç–µ–º–∏ BusOptima –Ω–∞ –±–∞–∑—ñ –º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ ESP32. –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –º–æ–¥—É–ª—å–Ω—É
–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É –∑ —Å—ñ–º–æ–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏: –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è, –º–æ–¥–µ–ª—ñ –¥–∞–Ω–∏—Ö, –±—É—Ñ–µ—Ä –ø–æ–¥—ñ–π, —Ä—É—à—ñ–π
—Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è, HTTP-–∫–ª—ñ—î–Ω—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä –¥–∏—Å–ø–ª–µ—è.
     –Ü–º–ø–ª–µ–º–µ–Ω—Ç–æ–≤–∞–Ω–æ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ —á–µ—Ä–µ–∑
PIR-–¥–∞—Ç—á–∏–∫–∏ –∑ –∞–ø–∞—Ä–∞—Ç–Ω–∏–º–∏ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è–º–∏ —Ç–∞ debounce-–º–µ—Ö–∞–Ω—ñ–∑–º–æ–º, –ª–æ–∫–∞–ª—å–Ω–µ
–¥–∏–Ω–∞–º—ñ—á–Ω–µ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑ —Ç—Ä—å–æ–º–∞ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∞–º–∏ (–ø–æ–ø–∏—Ç, —á–∞—Å, –¥–µ–Ω—å), –∫—ñ–ª—å—Ü–µ–≤–∏–π
–±—É—Ñ–µ—Ä –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ–≥–æ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–æ 10,000 –ø–æ–¥—ñ–π –∑ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—é —á–µ—Ä–µ–∑ LittleFS
–¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —Ç–∏–∂–Ω–µ–≤–æ—ó –∞–≤—Ç–æ–Ω–æ–º—ñ—ó.
     –†–æ–∑—Ä–æ–±–ª–µ–Ω–æ      —Å–∏—Å—Ç–µ–º—É   –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó   –∑   JWT-—Ç–æ–∫–µ–Ω–∞–º–∏,   –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º
–æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º —Ç–∞ –±–µ–∑–ø–µ—á–Ω–∏–º –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è–º –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö. –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–∏–π
—Ä–µ–∂–∏–º —Ä–æ–±–æ—Ç–∏ –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è–º –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ
—Å–µ—Ä–≤–µ—Ä–∞. –§—É–Ω–∫—Ü—ñ—ó –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤–∫–ª—é—á–∞—é—Ç—å: –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ WiFi-–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑
–ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º, NTP-—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —á–∞—Å—É, —Å–∫–∏–¥–∞–Ω–Ω—è –¥–æ –∑–∞–≤–æ–¥—Å—å–∫–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
—Ç–∞ –ø—Ä–∏–º—É—Å–æ–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ —Ñ—ñ–∑–∏—á–Ω—ñ –∫–Ω–æ–ø–∫–∏. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞
—á–µ—Ä–µ–∑ REST API –∑ –ø–æ–≤–Ω–æ—é –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é.
     –°—Ç–≤–æ—Ä–µ–Ω–æ UML –¥—ñ–∞–≥—Ä–∞–º–∏ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ñ–≤ —Ç–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç—É–≤–∞–Ω–Ω—è
–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ —Ç–∞ –±—ñ–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—ñ–≤ IoT –∫–ª—ñ—î–Ω—Ç–∞. –ü—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –¥–ª—è
—Å–∏–º—É–ª—è—Ü—ñ—ó —É Wokwi.
                                                                                12
                                   –î–û–î–ê–¢–û–ö –ê
                                     –í—ñ–¥–µ–æ–∑–∞–ø–∏—Å

        –í—ñ–¥–µ–æ–∑–∞–ø–∏—Å: https://youtu.be/jpcKZgYmTmM

        –•—Ä–æ–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π –æ–ø–∏—Å:
        00:15 ‚Äî –ó–∞–ø—É—Å–∫ –ø—Ä–æ—à–∏–≤–∫–∏, –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Wi-Fi —Ç–∞ —Ä–æ–±–æ—Ç–∞ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º—ñ.
        00:45 ‚Äî –û–ø–∏—Å —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –ø—Ä–∏—Å—Ç—Ä–æ—é: –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–∞—Å–∞–∂–∏—Ä—ñ–≤, –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å —Ç–∞
—Ü—ñ–Ω–∞.
        01:10 ‚Äî –ü–µ—Ä–µ—Ö—ñ–¥ –≤ –æ–Ω–ª–∞–π–Ω-—Ä–µ–∂–∏–º: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è
–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó.
        01:40 ‚Äî –î–∏–Ω–∞–º—ñ—á–Ω–µ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ —Ä–æ–±–æ—Ç–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é –≤ –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å—ñ.
        01:55 ‚Äî –°–∏–º—É–ª—è—Ü—ñ—è —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫—ñ–≤ —Ç–∞ —Ä—É—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –ø–æ–¥—ñ–π —ñ–∑
—Å–µ—Ä–≤–µ—Ä–æ–º.
        02:30 ‚Äî –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –≤ —Ç–∞–±–ª–∏—Ü—è—Ö –±–∞–∑–∏ –¥–∞–Ω–∏—Ö.
        03:05 ‚Äî –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ä–µ–∞–∫—Ü—ñ—ó –ø—Ä–∏—Å—Ç—Ä–æ—é –Ω–∞ –≤—Ç—Ä–∞—Ç—É –∑–≤‚Äô—è–∑–∫—É –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.
        03:40 ‚Äî –†–æ–±–æ—Ç–∞ –∑ –ª–æ–∫–∞–ª—å–Ω–∏–º –±—É—Ñ–µ—Ä–æ–º: –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–¥—ñ–π –ø—ñ–¥ —á–∞—Å –æ—Ñ–ª–∞–π–Ω—É.
        04:20 ‚Äî –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ —Ç–∞ –ø–∞–∫–µ—Ç–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –Ω–∞–∫–æ–ø–∏—á–µ–Ω–∏—Ö
–¥–∞–Ω–∏—Ö.
        05:00 ‚Äî –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ—Å—Ç—ñ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö.
        05:30 ‚Äî –§—É–Ω–∫—Ü—ñ—è —Å–∫–∏–¥–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –ø—Ä–∏—Å—Ç—Ä–æ—é —Ç–∞ —à–≤–∏–¥–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞
–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è.
        05:45 ‚Äî –î–µ—Ç–∞–ª—å–Ω–∏–π –æ–≥–ª—è–¥ —Ñ–∞–π–ª—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: –ø—ñ–Ω–∏, —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏ —Ç–∞ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏.
        06:40 ‚Äî –û–ø–∏—Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –±—É—Ñ–µ—Ä–æ–º, I2C —Ç–∞ —Å–∏—Å—Ç–µ–º–æ—é LittleFS.
                                                     13
                  –î–û–î–ê–¢–û–ö –ë
                –ì—Ä–∞—Ñ—ñ—á–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏




–†–∏—Å—É–Ω–æ–∫ –ë.2 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ñ–≤ IoT –∫–ª—ñ—î–Ω—Ç–∞
                                                               14




–†–∏—Å—É–Ω–æ–∫ –ë.3 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ –æ–±—Ä–æ–±–∫–∏ –ø–æ–¥—ñ—ó –ø–∞—Å–∞–∂–∏—Ä–∞
                                                                  15




–†–∏—Å—É–Ω–æ–∫ –ë.4 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è
                                                                                  16
                                      –î–û–î–ê–¢–û–ö –í
                                     –ü—Ä–æ–≥—Ä–∞–º–Ω–∏–π –∫–æ–¥

      –ü–æ–≤–Ω–∏–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç—É –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó GitHub –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º:
https://github.com/NureOsychenkoIllia/ark-pzpi-23-3-osychenko-illia/tree/main/Lab4/
ark-pzpi-23-3-osychenko-illia-lab4

      –í.1 –ì–æ–ª–æ–≤–Ω–∏–π –º–æ–¥—É–ª—å (main.cpp)

      GitHub      —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:   https://github.com/NureOsychenkoIllia/ark-pzpi-23-3-
osychenko-illia/tree/main/Lab4/ark-pzpi-23-3-osychenko-illia-lab4/src/main.cpp

  1   #include   <Arduino.h>
  2   #include   <WiFi.h>
  3   #include   <time.h>
  4   #include   "config.h"
  5   #include   "models.h"
  6   #include   "event_buffer.h"
  7   #include   "pricing_engine.h"
  8   #include   "api_client.h"
  9   #include   "display_manager.h"
 10
 11   EventBuffer eventBuffer;
 12   PricingEngine pricingEngine;
 13   ApiClient apiClient;
 14   DisplayManager display;
 15
 16   DeviceState deviceState;
 17   TripConfig tripConfig;
 18   PriceRecommendation currentPrice;
 19
 20   volatile   unsigned long lastEntryTrigger = 0;
 21   volatile   unsigned long lastExitTrigger = 0;
 22   volatile   bool entryDetected = false;
 23   volatile   bool exitDetected = false;
 24
 25   // –û–±—Ä–æ–±–Ω–∏–∫ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫–∞ –≤—Ö–æ–¥—É
 26   void IRAM_ATTR onEntryDetected() {
 27       unsigned long now = millis();
 28       if (now - lastEntryTrigger > SENSOR_DEBOUNCE_MS) {
 29           lastEntryTrigger = now;
 30           entryDetected = true;
 31       }
 32   }
 33
 34   // –û–±—Ä–æ–±–Ω–∏–∫ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è –¥–∞—Ç—á–∏–∫–∞ –≤–∏—Ö–æ–¥—É
 35   void IRAM_ATTR onExitDetected() {
 36       unsigned long now = millis();
 37       if (now - lastExitTrigger > SENSOR_DEBOUNCE_MS) {
 38           lastExitTrigger = now;
                                                                       17

39         exitDetected = true;
40     }
41 }
42
43 void handlePassengerEntry() {
44     deviceState.currentPassengers++;
45     deviceState.totalEntries++;
46     eventBuffer.addEvent(EVENT_ENTRY, deviceState.currentPassengers);
47     display.showPassengerEvent(EVENT_ENTRY,
   deviceState.currentPassengers);
48     Serial.printf("[Passenger] –í–•–Ü–î: –∫—ñ–ª—å–∫—ñ—Å—Ç—å = %d\n",
   deviceState.currentPassengers);
49 }
50
51 void handlePassengerExit() {
52     if (deviceState.currentPassengers > 0) {
53         deviceState.currentPassengers--;
54     }
55     deviceState.totalExits++;
56     eventBuffer.addEvent(EVENT_EXIT, deviceState.currentPassengers);
57     display.showPassengerEvent(EVENT_EXIT,
   deviceState.currentPassengers);
58     Serial.printf("[Passenger] –í–ò–•–Ü–î: –∫—ñ–ª—å–∫—ñ—Å—Ç—å = %d\n",
   deviceState.currentPassengers);
59 }
60
61 void setup() {
62     Serial.begin(115200);
63     Serial.println("BusOptima IoT Client v" FIRMWARE_VERSION);
64
65     // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è GPIO
66     pinMode(PIN_PIR_ENTRY, INPUT);
67     pinMode(PIN_PIR_EXIT, INPUT);
68     pinMode(PIN_LED_STATUS, OUTPUT);
69     pinMode(PIN_LED_WIFI, OUTPUT);
70     pinMode(PIN_LED_ERROR, OUTPUT);
71     pinMode(PIN_BTN_RESET, INPUT_PULLUP);
72     pinMode(PIN_BTN_SYNC, INPUT_PULLUP);
73
74     attachInterrupt(digitalPinToInterrupt(PIN_PIR_ENTRY),
   onEntryDetected, RISING);
75     attachInterrupt(digitalPinToInterrupt(PIN_PIR_EXIT),
   onExitDetected, RISING);
76
77     display.begin();
78     eventBuffer.begin();
79
80     // WiFi –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
81     WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
82     while (WiFi.status() != WL_CONNECTED) {
83         digitalWrite(PIN_LED_WIFI, !digitalRead(PIN_LED_WIFI));
84         delay(500);
85     }
86     digitalWrite(PIN_LED_WIFI, HIGH);
87
88     configTime(2 * 3600, 0, "pool.ntp.org");
                                                                                    18

 89 }
 90
 91 void loop() {
 92     if (entryDetected) {
 93         entryDetected = false;
 94         handlePassengerEntry();
 95     }
 96     if (exitDetected) {
 97         exitDetected = false;
 98         handlePassengerExit();
 99     }
100     // –ü–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ –∑–∞–¥–∞—á—ñ...
101     delay(10);
102 }


      –í.2 –†—É—à—ñ–π –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è (pricing_engine.h)

      GitHub    —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:     https://github.com/NureOsychenkoIllia/ark-pzpi-23-3-
osychenko-illia/tree/main/Lab4/ark-pzpi-23-3-osychenko-illia-lab4/src/pricing_engine.h

 1   #ifndef PRICING_ENGINE_H
 2   #define PRICING_ENGINE_H
 3
 4   #include "config.h"
 5   #include "models.h"
 6
 7   class PricingEngine {
 8   private:
 9       float calculateDemandCoefficient(float occupancyRate) {
10            if (occupancyRate < 30.0) return DEMAND_COEFF_LOW;             //   0.75
11            if (occupancyRate < 60.0) return DEMAND_COEFF_MEDIUM;          //   0.95
12            if (occupancyRate < 85.0) return DEMAND_COEFF_HIGH;            //   1.10
13            return DEMAND_COEFF_VERY_HIGH;                                 //   1.40
14       }
15
16       float calculateTimeCoefficient(int hour) {
17           if ((hour >= 7 && hour <= 9) || (hour >= 17 && hour <= 19)) {
18               return TIME_COEFF_PEAK;   // 1.20 - –ø—ñ–∫–æ–≤—ñ –≥–æ–¥–∏–Ω–∏
19           }
20           if (hour >= 23 || hour <= 6) {
21               return TIME_COEFF_NIGHT; // 0.80 - –Ω—ñ—á–Ω—ñ –≥–æ–¥–∏–Ω–∏
22           }
23           return TIME_COEFF_NORMAL;     // 1.00
24       }
25
26       float calculateDayCoefficient(int dayOfWeek) {
27           if (dayOfWeek == 0 || dayOfWeek == 6) {
28               return DAY_COEFF_WEEKEND; // 1.15 - –≤–∏—Ö—ñ–¥–Ω—ñ
29           }
30           return DAY_COEFF_WEEKDAY;     // 1.00
31       }
32
33   public:
                                                                                       19

34       PriceRecommendation calculatePrice(float basePrice, int
     currentPassengers,
35                                           int capacity, struct tm*
     timeinfo) {
36           PriceRecommendation rec;
37           rec.basePrice = basePrice;
38           rec.calculatedAt = millis();
39
40            rec.occupancyRate = (capacity > 0)
41                ? (float)currentPassengers / capacity * 100.0 : 0.0;
42
43           rec.demandCoeff =
     calculateDemandCoefficient(rec.occupancyRate);
44           rec.timeCoeff = calculateTimeCoefficient(timeinfo ? timeinfo-
     >tm_hour : 12);
45           rec.dayCoeff = calculateDayCoefficient(timeinfo ? timeinfo-
     >tm_wday : 1);
46
47           float rawPrice = basePrice * rec.demandCoeff * rec.timeCoeff *
     rec.dayCoeff;
48
49            // –û–±–º–µ–∂–µ–Ω–Ω—è –¥—ñ–∞–ø–∞–∑–æ–Ω—É 70%-150%
50            float minPrice = basePrice * PRICE_MIN_COEFF;
51            float maxPrice = basePrice * PRICE_MAX_COEFF;
52            rawPrice = constrain(rawPrice, minPrice, maxPrice);
53
54           // –û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ 5 –≥—Ä–Ω
55           rec.recommendedPrice = round(rawPrice / PRICE_ROUND_STEP) *
     PRICE_ROUND_STEP;
56
57            return rec;
58        }
59   };
60
61   #endif


      –í.3 –ë—É—Ñ–µ—Ä –ø–æ–¥—ñ–π (event_buffer.h)

      GitHub     —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:    https://github.com/NureOsychenkoIllia/ark-pzpi-23-3-
osychenko-illia/tree/main/Lab4/ark-pzpi-23-3-osychenko-illia-lab4/src/event_buffer.h

 1   #ifndef EVENT_BUFFER_H
 2   #define EVENT_BUFFER_H
 3
 4   #include "config.h"
 5   #include "models.h"
 6   #include <Preferences.h>
 7
 8   class EventBuffer {
 9   private:
10       PassengerEvent events[MAX_EVENTS_BUFFER];
11       int head, tail, count;
12       uint32_t nextLocalId;
                                                                         20

13      Preferences preferences;
14
15   public:
16       EventBuffer() : head(0), tail(0), count(0), nextLocalId(1) {}
17
18      void begin() {
19          preferences.begin("events", false);
20          nextLocalId = preferences.getUInt("nextId", 1);
21          count = preferences.getInt("count", 0);
22      }
23
24      bool addEvent(EventType type, int passengerCountAfter,
25                    float lat = 0.0, float lon = 0.0) {
26          if (count >= MAX_EVENTS_BUFFER) return false;
27
28          PassengerEvent& event = events[head];
29          event.localId = nextLocalId++;
30          event.type = type;
31          event.timestamp = millis() / 1000;
32          event.latitude = lat;
33          event.longitude = lon;
34          event.passengerCountAfter = passengerCountAfter;
35          event.isSynced = false;
36
37          head = (head + 1) % MAX_EVENTS_BUFFER;
38          count++;
39
40          preferences.putUInt("nextId", nextLocalId);
41          preferences.putInt("count", count);
42          return true;
43      }
44
45      int getUnsyncedEvents(PassengerEvent* buffer, int maxCount) {
46          int fetched = 0, idx = tail;
47          for (int i = 0; i < count && fetched < maxCount; i++) {
48              if (!events[idx].isSynced) buffer[fetched++] = events[idx];
49              idx = (idx + 1) % MAX_EVENTS_BUFFER;
50          }
51          return fetched;
52      }
53
54       void markSynced(uint32_t upToLocalId) {
55           int idx = tail;
56           for (int i = 0; i < count; i++) {
57               if (events[idx].localId <= upToLocalId)
     events[idx].isSynced = true;
58               idx = (idx + 1) % MAX_EVENTS_BUFFER;
59           }
60           while (count > 0 && events[tail].isSynced) {
61               tail = (tail + 1) % MAX_EVENTS_BUFFER;
62               count--;
63           }
64           preferences.putInt("count", count);
65       }
66
67      void clear() {
                                                                                     21

68            head = tail = count = 0;
69            nextLocalId = 1;
70            preferences.putUInt("nextId", 1);
71            preferences.putInt("count", 0);
72        }
73
74        int getCount() const { return count; }
75   };
76
77   #endif


      –í.4 HTTP –∫–ª—ñ—î–Ω—Ç (api_client.h)

      GitHub      —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:    https://github.com/NureOsychenkoIllia/ark-pzpi-23-3-
osychenko-illia/tree/main/Lab4/ark-pzpi-23-3-osychenko-illia-lab4/src/api_client.h

 1   #ifndef API_CLIENT_H
 2   #define API_CLIENT_H
 3
 4   #include   "config.h"
 5   #include   "models.h"
 6   #include   <WiFi.h>
 7   #include   <HTTPClient.h>
 8   #include   <ArduinoJson.h>
 9
10   class ApiClient {
11   private:
12       String serverUrl;
13       String authToken;
14
15   public:
16       ApiClient() {
17           serverUrl = String("http://") + SERVER_HOST + ":" +
     String(SERVER_PORT);
18           authToken = DEVICE_TOKEN;
19       }
20
21       SyncResult syncEvents(int64_t tripId, PassengerEvent* events, int
     count) {
22            SyncResult result = {false, 0, 0, "", ""};
23            if (count == 0) { result.success = true; return result; }
24
25            JsonDocument doc;
26            doc["trip_id"] = tripId;
27            JsonArray eventsArray = doc["events"].to<JsonArray>();
28
29           for (int i = 0; i < count; i++) {
30               JsonObject event = eventsArray.add<JsonObject>();
31               event["local_id"] = events[i].localId;
32               event["event_type"] = events[i].type == EVENT_ENTRY ?
     "entry" : "exit";
33               event["timestamp"] = "2025-12-25T12:00:00Z";
34               event["latitude"] = events[i].latitude;
                                                                                  22

35               event["longitude"] = events[i].longitude;
36               event["passenger_count_after"] =
     events[i].passengerCountAfter;
37           }
38
39           String jsonBody;
40           serializeJson(doc, jsonBody);
41           Serial.printf("[API] POST /iot/events: %s\n",
     jsonBody.c_str());
42
43            result.success = true;
44            result.syncedCount = count;
45            result.lastSyncedLocalId = events[count - 1].localId;
46            return result;
47        }
48
49       bool sendPriceRecommendation(int64_t tripId, const
     PriceRecommendation& rec) {
50           JsonDocument doc;
51           doc["trip_id"] = tripId;
52           doc["base_price"] = rec.basePrice;
53           doc["recommended_price"] = rec.recommendedPrice;
54           doc["occupancy_rate"] = rec.occupancyRate;
55           doc["demand_coefficient"] = rec.demandCoeff;
56           doc["time_coefficient"] = rec.timeCoeff;
57           doc["day_coefficient"] = rec.dayCoeff;
58
59            String jsonBody;
60            serializeJson(doc, jsonBody);
61            Serial.printf("[API] POST /iot/price: %s\n", jsonBody.c_str());
62            return true;
63        }
64
65        TripConfig getTripConfig(int64_t tripId) {
66            TripConfig config;
67            config.tripId = tripId;
68            config.routeId = 1;
69            config.busCapacity = DEFAULT_BUS_CAPACITY;
70            config.basePrice = DEFAULT_BASE_PRICE;
71            config.isValid = true;
72            return config;
73        }
74   };
75
76   #endif


      –í.5 –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (config.h)

      GitHub     —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:    https://github.com/NureOsychenkoIllia/ark-pzpi-23-3-
osychenko-illia/tree/main/Lab4/ark-pzpi-23-3-osychenko-illia-lab4/src/config.h

 1 #ifndef CONFIG_H
 2 #define CONFIG_H
                                                                      23

 3
 4   // WiFi
 5   #define WIFI_SSID "Wokwi-GUEST"
 6   #define WIFI_PASSWORD ""
 7   #define WIFI_CONNECT_TIMEOUT_MS 10000
 8
 9   // –°–µ—Ä–≤–µ—Ä
10   #define SERVER_HOST "busoptima-api.example.com"
11   #define SERVER_PORT 443
12   #define API_BASE_PATH "/api/iot"
13   #define DEVICE_TOKEN "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
14
15   // –ü—Ä–∏—Å—Ç—Ä—ñ–π
16   #define DEVICE_SERIAL "ESP32-BUS-001"
17   #define FIRMWARE_VERSION "1.0.0"
18   #define DEFAULT_TRIP_ID 1
19   #define DEFAULT_BUS_CAPACITY 50
20   #define DEFAULT_BASE_PRICE 200.0
21
22   // GPIO
23   #define   PIN_PIR_ENTRY 14
24   #define   PIN_PIR_EXIT 12
25   #define   PIN_LED_STATUS 25
26   #define   PIN_LED_WIFI 26
27   #define   PIN_LED_ERROR 27
28   #define   PIN_BTN_RESET 4
29   #define   PIN_BTN_SYNC 5
30
31   // –Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏
32   #define SYNC_INTERVAL_MS 300000
33   #define PRICE_CALC_INTERVAL_MS 300000
34   #define SENSOR_DEBOUNCE_MS 500
35   #define MAX_EVENTS_BUFFER 10000
36   #define EVENTS_BATCH_SIZE 100
37
38   // –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è
39   #define DEMAND_COEFF_LOW 0.75
40   #define DEMAND_COEFF_MEDIUM 0.95
41   #define DEMAND_COEFF_HIGH 1.10
42   #define DEMAND_COEFF_VERY_HIGH 1.40
43   #define TIME_COEFF_PEAK 1.20
44   #define TIME_COEFF_NIGHT 0.80
45   #define TIME_COEFF_NORMAL 1.00
46   #define DAY_COEFF_WEEKEND 1.15
47   #define DAY_COEFF_WEEKDAY 1.00
48   #define PRICE_MIN_COEFF 0.70
49   #define PRICE_MAX_COEFF 1.50
50   #define PRICE_ROUND_STEP 5.0
51
52   #endif
