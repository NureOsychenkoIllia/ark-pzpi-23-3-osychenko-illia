                    –ú–Ü–ù–Ü–°–¢–ï–†–°–¢–í–û –û–°–í–Ü–¢–ò –Ü –ù–ê–£–ö–ò –£–ö–†–ê–á–ù–ò
   –•–ê–†–ö–Ü–í–°–¨–ö–ò–ô –ù–ê–¶–Ü–û–ù–ê–õ–¨–ù–ò–ô –£–ù–Ü–í–ï–†–°–ò–¢–ï–¢ –†–ê–î–Ü–û–ï–õ–ï–ö–¢–†–û–ù–Ü–ö–ò



                           –ö–∞—Ñ–µ–¥—Ä–∞ –ü—Ä–æ–≥—Ä–∞–º–Ω–æ—ó —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó




                                        –ó–≤—ñ—Ç
                             –∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ ‚Ññ5
                     –∑ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∏: ¬´–ê–Ω–∞–ª—ñ–∑ —Ç–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω“ë –∫–æ–¥—É¬ª
       –∑ —Ç–µ–º–∏: ¬´–†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è —ó—ó —Ä–æ–±–æ—Ç–∏¬ª




–í–∏–∫–æ–Ω–∞–≤:                                                               –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤:
—Å—Ç. –≥—Ä. –ü–ó–ü–Ü-23-3                                          —Å—Ç. –≤–∏–∫–ª–∞–¥–∞—á –∫–∞—Ç–µ–¥—Ä–∏ –ü–Ü
–û—Å–∏—á–µ–Ω–∫–æ –Ü. –û.                                                      –°–æ–∫–æ—Ä—á—É–∫ –Ü. –ü.




                                   –•–∞—Ä–∫—ñ–≤ ‚Äì 2025
                                                                              2
                               1 –Ü–°–¢–û–†–Ü–Ø –ó–ú–Ü–ù

‚Ññ    –î–∞—Ç–∞    –í–µ—Ä—Å—ñ—è –∑–≤—ñ—Ç—É    –û–ø–∏—Å –∑–º—ñ–Ω —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å
1 26.12.2025     0.1         –°—Ç–≤–æ—Ä–µ–Ω–æ —Ä–æ–∑–¥—ñ–ª ¬´–ó–∞–≤–¥–∞–Ω–Ω—è¬ª
2 26.12.2025     0.2         –°—Ç–≤–æ—Ä–µ–Ω–æ —Ä–æ–∑–¥—ñ–ª ¬´–û–ø–∏—Å –≤–∏–∫–æ–Ω–∞–Ω–æ—ó —Ä–æ–±–æ—Ç–∏¬ª
3 26.12.2025     1.0         –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Ä–æ–±–æ—Ç—É –Ω–∞–¥ –∑–≤—ñ—Ç–æ–º



                                2 –ó–ê–í–î–ê–ù–ù–Ø


     –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω—É –ø—Ä–æ–≥—Ä–∞–º–Ω—É —Å–∏—Å—Ç–µ–º—É BusOptima –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º Docker.
–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –¥–ª—è —Ä–æ–±–æ—Ç–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏, –±–∞–∑–∏ –¥–∞–Ω–∏—Ö —Ç–∞ IoT –∫–ª—ñ—î–Ω—Ç–∞.
–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Ç–∞ –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ –≤—Å—ñ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤. –ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä—É–≤–∞—Ç–∏
—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ Vision & Scope —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–¥–µ–æ–∑–∞–ø–∏—Å
–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó.
                                                                                 3
                        3 –û–ü–ò–° –í–ò–ö–û–ù–ê–ù–û–á –†–û–ë–û–¢–ò

      3.1 –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è

      –°–∏—Å—Ç–µ–º–∞ BusOptima —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —Ç—Ä—å–æ—Ö –æ—Å–Ω–æ–≤–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤: —Å–µ—Ä–≤–µ—Ä–Ω–∞
—á–∞—Å—Ç–∏–Ω–∞ (Go REST API), –±–∞–∑–∞ –¥–∞–Ω–∏—Ö PostgreSQL —Ç–∞ IoT –∫–ª—ñ—î–Ω—Ç –Ω–∞ ESP32. –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
–≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ Docker Compose –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∞ PlatformIO –¥–ª—è
IoT –∫–ª—ñ—î–Ω—Ç–∞.

–¢–∞–±–ª–∏—Ü—è 3.1 ‚Äì –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç      –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—è                                                    –ü–æ—Ä—Ç
API —Å–µ—Ä–≤–µ—Ä     Go 1.25 + Fiber                                               8080
–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö     PostgreSQL 17                                                 5432
Adminer        PHP –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å                                             8081
IoT –∫–ª—ñ—î–Ω—Ç     ESP32 + Arduino                                               ‚Äî

      3.2 –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏

      3.2.1 Docker Compose –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

      –°–µ—Ä–≤–µ—Ä–Ω–∞ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–æ–∑–≥–æ—Ä—Ç–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ docker-compose.yml –∑ —Ç—Ä—å–æ–º–∞
—Å–µ—Ä–≤—ñ—Å–∞–º–∏: postgres –¥–ª—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, api –¥–ª—è REST API —Ç–∞ adminer –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è
–ë–î.

 1 services:
 2   postgres:
 3     image: postgres:17-alpine
 4     container_name: busoptima_db
 5     environment:
 6        POSTGRES_DB: busoptima
 7        POSTGRES_USER: busoptima_user
 8        POSTGRES_PASSWORD: busoptima_pass
 9     ports:
10        - "5432:5432"
11     volumes:
12        - postgres_data:/var/lib/postgresql/data
13        - ./migrations:/docker-entrypoint-initdb.d
14     networks:
15        - busoptima_network
16
17   api:
18     build: .
19     container_name: busoptima_api
20     environment:
                                                                                  4

21         DATABASE_URL: postgres://busoptima_user:busoptima_pass@postgres:
     5432/busoptima?sslmode=disable
22         JWT_SECRET: super-secret-jwt-key
23         PORT: 8080
24       ports:
25         - "0.0.0.0:8080:8080"
26       volumes:
27         - backup_data:/app/backups
28       depends_on:
29         - postgres
30       networks:
31         - busoptima_network
32       restart: unless-stopped


      PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–æ–Ω—É—î SQL-–º—ñ–≥—Ä–∞—Ü—ñ—ó –∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
migrations –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É. API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–±–∏—Ä–∞—î—Ç—å—Å—è –∑ Dockerfile —Ç–∞
–ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä—ñ—à–Ω—é Docker –º–µ—Ä–µ–∂—É.

      3.2.2 Dockerfile —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏

      –ó–±—ñ—Ä–∫–∞ API –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —É –¥–≤–∞ –µ—Ç–∞–ø–∏ (multi-stage build) –¥–ª—è –º—ñ–Ω—ñ–º—ñ–∑–∞—Ü—ñ—ó —Ä–æ–∑–º—ñ—Ä—É
—Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑—É:

 1   FROM golang:1.25-alpine AS builder
 2   WORKDIR /app
 3   COPY go.mod go.sum ./
 4   RUN go mod download
 5   RUN go install github.com/swaggo/swag/cmd/swag@latest
 6   COPY . .
 7   RUN swag init -g cmd/api/main.go
 8   RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main ./
     cmd/api
 9
10   FROM alpine:latest
11   RUN apk --no-cache add ca-certificates
12   WORKDIR /root/
13   COPY --from=builder /app/main .
14   EXPOSE 8080
15   CMD ["./main"]


      –ü–µ—Ä—à–∏–π –µ—Ç–∞–ø (builder) –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ, –≥–µ–Ω–µ—Ä—É—î Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é
—Ç–∞ –∫–æ–º–ø—ñ–ª—é—î –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª. –î—Ä—É–≥–∏–π –µ—Ç–∞–ø –∫–æ–ø—ñ—é—î –ª–∏—à–µ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–∫ –≤
–º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π Alpine –æ–±—Ä–∞–∑.

      3.2.3 Makefile –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó

      Makefile –Ω–∞–¥–∞—î –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è —Ç–∏–ø–æ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Ç–∞ —Ä–æ–∑—Ä–æ–±–∫–∏:
                                                                                   5

 1 docker-up: ## –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Å–µ—Ä–≤—ñ—Å–∏ —á–µ—Ä–µ–∑ Docker Compose
 2   @$(DOCKER_COMPOSE) up -d
 3
 4 docker-down: ## –ó—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ Docker —Å–µ—Ä–≤—ñ—Å–∏
 5   @$(DOCKER_COMPOSE) down
 6
 7 migrate-up: ## –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó –ë–î
 8   @docker exec -i busoptima_db psql -U busoptima_user -d busoptima <
   migrations/001_initial_schema.sql
 9   @docker exec -i busoptima_db psql -U busoptima_user -d busoptima <
   migrations/002_initial_data.sql
10
11 quickstart: deps docker-up migrate-up ## –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç –ø—Ä–æ–µ–∫—Ç—É
12   @echo "–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤–∏–π –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è!"


     –ö–æ–º–∞–Ω–¥–∞ ¬´make quickstart¬ª –≤–∏–∫–æ–Ω—É—î –ø–æ–≤–Ω–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏: –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
–∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π, –∑–∞–ø—É—Å–∫ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π –±–∞–∑–∏ –¥–∞–Ω–∏—Ö.

     3.3 –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

     3.3.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º—ñ–≥—Ä–∞—Ü—ñ–π

     –ú—ñ–≥—Ä–∞—Ü—ñ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –æ—Ä–≥–∞–Ω—ñ–∑–æ–≤–∞–Ω—ñ —É –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ SQL-—Ñ–∞–π–ª–∏:
      ‚Äì   001_initial_schema.sql ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å (users, roles, routes, buses,
          trips, devices)
      ‚Äì   002_initial_data.sql ‚Äî –ø–æ—á–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ (—Ä–æ–ª—ñ, –¥–æ–∑–≤–æ–ª–∏, —Ç–µ—Å—Ç–æ–≤—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ)
      ‚Äì   003_system_settings.sql ‚Äî —Ç–∞–±–ª–∏—Ü—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
      ‚Äì   004_add_passenger_events.sql ‚Äî —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –ø–æ–¥—ñ–π –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏
      ‚Äì   005_rich_demo_data.sql ‚Äî –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

     3.3.2 ER-–¥—ñ–∞–≥—Ä–∞–º–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

     –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –º—ñ—Å—Ç–∏—Ç—å 12 –æ—Å–Ω–æ–≤–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å (–¥–∏–≤. —Ä–∏—Å. –ë.1): users —Ç–∞ roles
–¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, routes —Ç–∞ buses –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ —Ç–∞ –∞–≤—Ç–æ–±—É—Å–∞–º–∏,
trips –¥–ª—è —Ä–µ–π—Å—ñ–≤, devices –¥–ª—è IoT –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤, passenger_events –¥–ª—è –ø–æ–¥—ñ–π –ø–∞—Å–∞–∂–∏—Ä—ñ–≤,
price_recommendations –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π —Ü—ñ–Ω, trip_analytics —Ç–∞ demand_forecasts –¥–ª—è
–∞–Ω–∞–ª—ñ—Ç–∏–∫–∏, system_settings –¥–ª—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó, audit_logs –¥–ª—è –∂—É—Ä–Ω–∞–ª—É –∞—É–¥–∏—Ç—É.
                                                                              6
      3.4 –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è IoT –∫–ª—ñ—î–Ω—Ç–∞

      3.4.1 PlatformIO –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

      IoT –∫–ª—ñ—î–Ω—Ç —Ä–æ–∑–≥–æ—Ä—Ç–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ PlatformIO –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—î—é –¥–ª—è ESP32:

1   [env:esp32dev]
2   platform = espressif32
3   board = esp32dev
4   framework = arduino
5   monitor_speed = 115200
6   lib_deps =
7       bblanchon/ArduinoJson@^7.0.0
8       marcoschwartz/LiquidCrystal_I2C@^1.1.4


      –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ     –≤–∫–ª—é—á–∞—é—Ç—å      ArduinoJson   –¥–ª—è   —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó   JSON   —Ç–∞
LiquidCrystal_I2C –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ LCD-–¥–∏—Å–ø–ª–µ—î–º.

      3.4.2 Wokwi —Å–∏–º—É–ª—è—Ü—ñ—è

      –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑ —Ñ—ñ–∑–∏—á–Ω–æ–≥–æ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å–∏–º—É–ª—è—Ç–æ—Ä
Wokwi. –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è wokwi.toml:

1   [wokwi]
2   version = 1
3   firmware = ".pio/build/esp32dev/firmware.bin"
4   elf = ".pio/build/esp32dev/firmware.elf"
5
6   [[net.forward]]
7   from = "localhost:8080"
8   to = "host:8080"


      Wokwi IoT Gateway –∑–∞–±–µ–∑–ø–µ—á—É—î –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ WiFi-–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∏–º—É–ª—å–æ–≤–∞–Ω–æ–≥–æ
ESP32 –¥–æ –ª–æ–∫–∞–ª—å–Ω–æ—ó –º–µ—Ä–µ–∂—ñ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è HTTP-–∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –∑ —Ä–µ–∞–ª—å–Ω–∏–º —Å–µ—Ä–≤–µ—Ä–æ–º.

      3.4.3 –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–µ—Ä–µ–∂—ñ IoT

      –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ IoT –∫–ª—ñ—î–Ω—Ç–∞ –≤ config.h:

1   #define   WIFI_SSID "Wokwi-GUEST"
2   #define   WIFI_PASSWORD ""
3   #define   SERVER_HOST "busoptima-api.example.com"
4   #define   SERVER_PORT 443
5   #define   API_BASE_PATH "/api/iot"
6   #define   DEVICE_TOKEN "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                                                                        7
      –î–ª—è production —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –∑–º—ñ–Ω–∏—Ç–∏ WIFI_SSID, WIFI_PASSWORD
—Ç–∞ SERVER_HOST –Ω–∞ —Ä–µ–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è.

      3.5 –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–±–æ—Ç–∏ —Å–∏—Å—Ç–µ–º–∏

      3.5.1 –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏

      –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ API –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ HTTP-–∑–∞–ø–∏—Ç–∏ –¥–æ –æ—Å–Ω–æ–≤–Ω–∏—Ö
–µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤:

 1   # –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è
 2   curl -X POST http://localhost:8080/api/auth/login \
 3     -H "Content-Type: application/json" \
 4     -d '{"email":"admin@busoptima.ua","password":"password123"}'
 5
 6   # –û—Ç—Ä–∏–º–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤
 7   curl -X GET http://localhost:8080/api/routes \
 8     -H "Authorization: Bearer <token>"
 9
10   # –ü–∞–Ω–µ–ª—å –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏
11   curl -X GET http://localhost:8080/api/analytics/dashboard \
12     -H "Authorization: Bearer <token>"


      3.5.2 –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è IoT –∫–ª—ñ—î–Ω—Ç–∞

      –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ IoT –∫–ª—ñ—î–Ω—Ç–∞ –≤–∫–ª—é—á–∞—î:
       ‚Äì   –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ WiFi –º–µ—Ä–µ–∂—ñ (—ñ–Ω–¥–∏–∫–∞—Ü—ñ—è LED_WIFI)
       ‚Äì   –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ —á–µ—Ä–µ–∑ /api/auth/device
       ‚Äì   –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ä–µ–π—Å—É —á–µ—Ä–µ–∑ /api/iot/config
       ‚Äì   –°–∏–º—É–ª—è—Ü—ñ—è —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è PIR-–¥–∞—Ç—á–∏–∫—ñ–≤
       ‚Äì   –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –ø–æ–¥—ñ–π –∑ —Å–µ—Ä–≤–µ—Ä–æ–º —á–µ—Ä–µ–∑ /api/iot/events
       ‚Äì   –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π —Ü—ñ–Ω–∏ —á–µ—Ä–µ–∑ /api/iot/price

      3.5.3 –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∑–∞—î–º–æ–¥—ñ—ó –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤

      –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä—è—î –ø–æ–≤–Ω–∏–π —Ü–∏–∫–ª –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö:
      –∞)   IoT –ø—Ä–∏—Å—Ç—Ä—ñ–π —Ñ—ñ–∫—Å—É—î –≤—Ö—ñ–¥ –ø–∞—Å–∞–∂–∏—Ä–∞ —á–µ—Ä–µ–∑ PIR-–¥–∞—Ç—á–∏–∫
      –±)   –ü–æ–¥—ñ—è –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –±—É—Ñ–µ—Ä—ñ EventBuffer
      –≤)   –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –ø–æ–¥—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      –≥)   –°–µ—Ä–≤–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–¥—ñ—é –≤ —Ç–∞–±–ª–∏—Ü—ñ passenger_events
                                                                                         8
     –¥)          –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –º–æ–¥—É–ª—å –æ–Ω–æ–≤–ª—é—î trip_analytics
     –µ)          –î–∏—Å–ø–µ—Ç—á–µ—Ä –±–∞—á–∏—Ç—å –æ–Ω–æ–≤–ª–µ–Ω—ñ –¥–∞–Ω—ñ –Ω–∞ –ø–∞–Ω–µ–ª—ñ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É

     3.6 –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ

     3.6.1 –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ —Å–∏—Å—Ç–µ–º–∏ (MF-1 ‚Äî MF-5)

     –í—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ Vision & Scope, —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–ª—ñ–∑—É—î —à—ñ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π:
     MF-1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ ‚Äî IoT –ø—Ä–∏—Å—Ç—Ä—ñ–π —Ñ—ñ–∫—Å—É—î –≤—Ö—ñ–¥/–≤–∏—Ö—ñ–¥
—á–µ—Ä–µ–∑ PIR-–¥–∞—Ç—á–∏–∫–∏ –∑ debounce-–º–µ—Ö–∞–Ω—ñ–∑–º–æ–º 500 –º—Å (–¥–∏–≤. —Ä–∏—Å. –ë.6). –ö–æ–∂–Ω–∞ –ø–æ–¥—ñ—è
–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∑ –º—ñ—Ç–∫–æ—é —á–∞—Å—É —Ç–∞ GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏.
     MF-2: –õ–æ–∫–∞–ª—å–Ω–µ –¥–∏–Ω–∞–º—ñ—á–Ω–µ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è ‚Äî IoT –ø—Ä–∏—Å—Ç—Ä—ñ–π —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î
—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—É              —Ü—ñ–Ω—É   –∑–∞   —Ñ–æ—Ä–º—É–ª–æ—é    ùëÉ—Ä–µ–∫ = ùëÉ–±–∞–∑ √ó ùêæ–ø–æ–ø–∏—Ç √ó ùêæ—á–∞—Å √ó ùêæ–¥–µ–Ω—å   –∑
–æ–±–º–µ–∂–µ–Ω–Ω—è–º –¥—ñ–∞–ø–∞–∑–æ–Ω—É 70-150% —Ç–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è–º –¥–æ 5 –≥—Ä–Ω (–¥–∏–≤. —Ä–∏—Å. –ë.7).
     MF-3: –ü—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è –ø–æ–ø–∏—Ç—É ‚Äî —Å–µ—Ä–≤–µ—Ä –∞–Ω–∞–ª—ñ–∑—É—î —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ –∑–∞ 12 —Ç–∏–∂–Ω—ñ–≤
–º–µ—Ç–æ–¥–æ–º –∫–æ–≤–∑–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∞–º–∏ —Ç—Ä–µ–Ω–¥—É —Ç–∞ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—ñ (–¥–∏–≤. —Ä–∏—Å. –ë.5).
–ì–µ–Ω–µ—Ä—É—é—Ç—å—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó ¬´–¥–æ–¥–∞—Ç–∏ —Ä–µ–π—Å¬ª –∞–±–æ ¬´—Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ä–µ–π—Å¬ª.
     MF-4: –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ ‚Äî —â–æ–¥–µ–Ω–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø—Ä–∏–±—É—Ç–∫–æ–≤–æ—Å—Ç—ñ
—Ä–µ–π—Å—ñ–≤       –∑     –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—î—é:     –∑–±–∏—Ç–∫–æ–≤–∏–π   (<0%),   –Ω–∏–∑—å–∫–æ—Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–∏–π    (0-20%),
–Ω–æ—Ä–º–∞–ª—å–Ω–∏–π (20-50%), –≤–∏—Å–æ–∫–æ—Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–∏–π (>50%) (–¥–∏–≤. —Ä–∏—Å. –ë.4).
     MF-5: –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —É —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ ‚Äî –ø–∞–Ω–µ–ª—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –∞–∫—Ç–∏–≤–Ω—ñ
—Ä–µ–π—Å–∏ –∑ —ñ–Ω–¥–∏–∫–∞—Ü—ñ—î—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ—Å—Ç—ñ —Ç–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è–º–∏ –ø—Ä–æ –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–¥—ñ—ó.

     3.6.2 –§—É–Ω–∫—Ü—ñ—ó –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è

     –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–Ω–µ–ª—å –Ω–∞–¥–∞—î:
         ‚Äì       –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏ (CRUD –æ–ø–µ—Ä–∞—Ü—ñ—ó)
         ‚Äì       –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π RBAC –∑ —Ç—Ä—å–æ–º–∞ —Ä–æ–ª—è–º–∏ (dispatcher, admin, tech_admin)
         ‚Äì       –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ (–∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è, –ø–æ—Ä–æ–≥–∏
                 –ø–æ–ø–∏—Ç—É)
         ‚Äì       –ï–∫—Å–ø–æ—Ä—Ç/—ñ–º–ø–æ—Ä—Ç –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–∏—Å—Ç–µ–º–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON
         ‚Äì       –ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç—É –≤—Å—ñ—Ö –º–æ–¥–∏—Ñ—ñ–∫—É—é—á–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
         ‚Äì       –†–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
                                                                              9
       3.6.3 –ï–∫—Å–ø–æ—Ä—Ç —Ç–∞ —ñ–º–ø–æ—Ä—Ç –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å

       –°–∏—Å—Ç–µ–º–∞ –ø—ñ–¥—Ç—Ä–∏–º—É—î –µ–∫—Å–ø–æ—Ä—Ç —Ç–∞ —ñ–º–ø–æ—Ä—Ç —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ
–∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∞–±–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—è –º—ñ–∂ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞–º–∏.
       Makefile –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏:

1   make settings-export    # –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —É busoptima_settings.json
2   make settings-import    # –Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑ busoptima_settings.json
3   make settings-show      # –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è


       GET /api/admin/settings/export ‚Äî –µ–∫—Å–ø–æ—Ä—Ç—É—î –ø–æ—Ç–æ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:

 1 {
 2         "version": "1.0",
 3         "exported_at": "2025-12-26T15:30:00Z",
 4         "settings": {
 5             "fuel_price_per_liter": 52.50,
 6             "peak_hours_coefficient": 1.30,
 7             "weekend_coefficient": 1.20,
 8             "high_demand_threshold": 85,
 9             "low_demand_threshold": 30,
10             "price_min_coefficient": 0.65,
11             "price_max_coefficient": 1.60,
12             "seasonal_coefficients": {
13                 "spring": 1.00, "summer": 1.20,
14                 "autumn": 1.10, "winter": 0.90
15             }
16         }
17 }


       POST /api/admin/settings/import ‚Äî —ñ–º–ø–æ—Ä—Ç—É—î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑ JSON —Ñ–∞–π–ª—É.
–°–∏—Å—Ç–µ–º–∞ –≤–∞–ª—ñ–¥—É—î –≤—Å—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø–µ—Ä–µ–¥ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è–º —Ç–∞ —Ñ—ñ–∫—Å—É—î –∑–º—ñ–Ω–∏ –≤ –∂—É—Ä–Ω–∞–ª—ñ
–∞—É–¥–∏—Ç—É.

       3.6.4 –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è IoT –∫–ª—ñ—î–Ω—Ç–∞

       IoT –∫–ª—ñ—î–Ω—Ç (–¥–∏–≤. —Ä–∏—Å. –ë.3) –ø—ñ–¥—Ç—Ä–∏–º—É—î:
       ‚Äì    –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ WiFi-–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º
       ‚Äì    JWT-–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∑ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º —Ç–æ–∫–µ–Ω—ñ–≤
       ‚Äì    –ê–≤—Ç–æ–Ω–æ–º–Ω–∏–π —Ä–µ–∂–∏–º –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è (–±—É—Ñ–µ—Ä 10,000 –ø–æ–¥—ñ–π)
       ‚Äì    –°–∫–∏–¥–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É Reset
       ‚Äì    –ü—Ä–∏–º—É—Å–æ–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É Sync
       ‚Äì    –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –Ω–∞ LCD-–¥–∏—Å–ø–ª–µ—ó
                                                                                  10
      3.6.5 –í–∑–∞—î–º–æ–¥—ñ—è IoT –∫–ª—ñ—î–Ω—Ç–∞ —Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞

      REST API –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏ –¥–ª—è IoT:

–¢–∞–±–ª–∏—Ü—è 3.2 ‚Äì API –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏ IoT –∫–ª—ñ—î–Ω—Ç–∞
–ú–µ—Ç–æ–¥    –ï–Ω–¥–ø–æ—ñ–Ω—Ç                               –û–ø–∏—Å
POST     /api/auth/device                       –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø—Ä–∏—Å—Ç—Ä–æ—é
GET      /api/iot/config/{tripId}               –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Ä–µ–π—Å—É
POST     /api/iot/events                        –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –ø–æ–¥—ñ–π
POST     /api/iot/price                         –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è —Ü—ñ–Ω–∏

      –§–æ—Ä–º–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –ø–æ–¥—ñ–π:

 1 POST /api/iot/events
 2 {
 3     "trip_id": 1,
 4     "events": [{
 5         "local_id": 1,
 6         "event_type": "entry",
 7         "timestamp": "2025-12-26T08:15:00Z",
 8         "latitude": 49.9935,
 9         "longitude": 36.2304,
10         "passenger_count_after": 15
11     }]
12 }


      3.7 –°—Ö–µ–º–∏ –≤–∑–∞—î–º–æ–¥—ñ—ó –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤

      –ó–∞–≥–∞–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∞ UML –¥—ñ–∞–≥—Ä–∞–º—ñ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ñ–≤
(–¥–∏–≤. —Ä–∏—Å. –ë.2), —è–∫–∞ –æ–ø–∏—Å—É—î –æ—Å–Ω–æ–≤–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó –∞–∫—Ç–æ—Ä—ñ–≤ (–¥–∏—Å–ø–µ—Ç—á–µ—Ä,
–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä, IoT-–ø—Ä–∏—Å—Ç—Ä—ñ–π) –∑ —Å–∏—Å—Ç–µ–º–æ—é BusOptima.
      –ü—Ä–æ—Ü–µ—Å    –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è       –ø–æ–ø–∏—Ç—É   (–¥–∏–≤.   —Ä–∏—Å.   –ë.5)   –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î   –æ–±–º—ñ–Ω
–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏ –º—ñ–∂ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏: AnalyticsHandler –≤–∞–ª—ñ–¥—É—î –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑–∞–ø–∏—Ç—É,
ForecastService –æ—Ç—Ä–∏–º—É—î —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ AnalyticsRepository, –æ–±—á–∏—Å–ª—é—î –∫–æ–≤–∑–Ω–µ
—Å–µ—Ä–µ–¥–Ω—î —Ç–∞ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏, —Ñ–æ—Ä–º—É—î –ø—Ä–æ–≥–Ω–æ–∑ –∑ –¥–æ–≤—ñ—Ä—á–∏–º —ñ–Ω—Ç–µ—Ä–≤–∞–ª–æ–º.
      –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –º—ñ–∂ IoT –∫–ª—ñ—î–Ω—Ç–æ–º —Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–º (–¥–∏–≤. —Ä–∏—Å. –ë.8) –≤–∫–ª—é—á–∞—î
–ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è, –≤–∏–±—ñ—Ä–∫—É –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏—Ö –ø–æ–¥—ñ–π –∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞,
–≤—ñ–¥–ø—Ä–∞–≤–∫—É –ø–∞–∫–µ—Ç–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Ç–∞ –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ–¥—ñ–π —è–∫ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏—Ö –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó
–≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.
                                                                            11
                                 –í–ò–°–ù–û–í–ö–ò


     –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–Ω—É —Å–∏—Å—Ç–µ–º—É
BusOptima –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º Docker Compose –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∞
PlatformIO –¥–ª—è IoT –∫–ª—ñ—î–Ω—Ç–∞. –ù–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –∑ —Ç—Ä—å–æ–º–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏:
PostgreSQL 17 –¥–ª—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, Go API —Å–µ—Ä–≤–µ—Ä —Ç–∞ Adminer –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è –ë–î.
     –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ –≤—Å—ñ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤: —Å–µ—Ä–≤–µ—Ä–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ
–æ–±—Ä–æ–±–ª—è—î HTTP-–∑–∞–ø–∏—Ç–∏, –±–∞–∑–∞ –¥–∞–Ω–∏—Ö –∑–±–µ—Ä—ñ–≥–∞—î —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î –¥–∞–Ω—ñ, IoT –∫–ª—ñ—î–Ω—Ç —É—Å–ø—ñ—à–Ω–æ
—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î –ø–æ–¥—ñ—ó –∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–æ–≤–∞–Ω–æ –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –∑ Vision & Scope:
–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤, –¥–∏–Ω–∞–º—ñ—á–Ω–µ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è, –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è
–ø–æ–ø–∏—Ç—É, –∞–Ω–∞–ª—ñ—Ç–∏–∫—É —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ, —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —É —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.
                                                                            12
                                 –î–û–î–ê–¢–û–ö –ê
                                  –í—ñ–¥–µ–æ–∑–∞–ø–∏—Å

      –í—ñ–¥–µ–æ–∑–∞–ø–∏—Å: https://youtu.be/jpcKZgYmTmM

      –•—Ä–æ–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π –æ–ø–∏—Å:
      00:10 ‚Äî –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –±–µ–∫–µ–Ω–¥—É.
      00:51 ‚Äî –ó–∞–ø—É—Å–∫ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Makefile —Ç–∞ Docker
Compose.
      01:21 ‚Äî –ê–Ω–∞–ª—ñ–∑ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ñ–∞–π–ª—ñ–≤ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –ø—Ä–∏
—Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—ñ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.
      02:29 ‚Äî –£—Å–ø—ñ—à–Ω–∏–π –∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–∏, –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤.
      03:21 ‚Äî –í–µ–±-–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
—á–µ—Ä–µ–∑ JWT.
      04:06 ‚Äî –û–≥–ª—è–¥ —Ñ—É–Ω–∫—Ü—ñ–π: –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤ –ø–æ–ø–∏—Ç—É —Ç–∞ –∞–Ω–∞–ª—ñ–∑ –ø—Ä–∏–±—É—Ç–∫–æ–≤–æ—Å—Ç—ñ
—Ä–µ–π—Å—ñ–≤.
      04:35 ‚Äî –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è –º–µ—Ö–∞–Ω—ñ–∑–º—É –µ–∫—Å–ø–æ—Ä—Ç—É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω–∏–π
—Ä—è–¥–æ–∫.
      06:22 ‚Äî –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–∞–π–ª—É —Ç–∞ —ñ–º–ø–æ—Ä—Ç –æ–Ω–æ–≤–ª–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö —É
—Å–∏—Å—Ç–µ–º—É.
      07:11 ‚Äî –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è IoT-–∫–ª—ñ—î–Ω—Ç–∞ –¥–æ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.
      08:01 ‚Äî –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –ø–æ–¥—ñ–π –∑ IoT-–ø—Ä–∏—Å—Ç—Ä–æ—é —Ç–∞ —Ñ—ñ–Ω–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∞–Ω–∏—Ö –Ω–∞
—Å–µ—Ä–≤–µ—Ä—ñ.
                                       13
           –î–û–î–ê–¢–û–ö –ë
         –ì—Ä–∞—Ñ—ñ—á–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏




–†–∏—Å—É–Ω–æ–∫ –ë.1 ‚Äì ER-–¥—ñ–∞–≥—Ä–∞–º–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
                                                 14




–†–∏—Å—É–Ω–æ–∫ –ë.2 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ñ–≤ —Å–∏—Å—Ç–µ–º–∏
                                                     15




–†–∏—Å—É–Ω–æ–∫ –ë.3 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç—ñ–≤ IoT –∫–ª—ñ—î–Ω—Ç–∞
                                                                  16




–†–∏—Å—É–Ω–æ–∫ –ë.4 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ
                                                                17




–†–∏—Å—É–Ω–æ–∫ –ë.5 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è –ø–æ–ø–∏—Ç—É
                                                               18




–†–∏—Å—É–Ω–æ–∫ –ë.6 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ –æ–±—Ä–æ–±–∫–∏ –ø–æ–¥—ñ—ó –ø–∞—Å–∞–∂–∏—Ä–∞
                                                                      19




–†–∏—Å—É–Ω–æ–∫ –ë.7 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è IoT
                                                            20




–†–∏—Å—É–Ω–æ–∫ –ë.8 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö
                                                                           21
                                   –î–û–î–ê–¢–û–ö –í
                                  –ü—Ä–æ–≥—Ä–∞–º–Ω–∏–π –∫–æ–¥

      –ü–æ–≤–Ω–∏–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç—É: https://github.com/NureOsychenkoIllia/ark-pzpi-23-3-
osychenko-illia/tree/main/Lab5/ark-pzpi-23-3-osychenko-illia-lab5

      –í.1 –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏ (main.go)

 1   package main
 2
 3   import (
 4     "log"
 5     "github.com/gofiber/fiber/v2"
 6     "github.com/gofiber/fiber/v2/middleware/cors"
 7     "github.com/gofiber/fiber/v2/middleware/logger"
 8     "github.com/jmoiron/sqlx"
 9     _ "github.com/lib/pq"
10     "busoptima/internal/config"
11     "busoptima/internal/handler"
12     "busoptima/internal/middleware"
13     "busoptima/internal/repository"
14     "busoptima/internal/service"
15   )
16
17   func main() {
18     cfg := config.Load()
19
20     db, err := sqlx.Connect("postgres", cfg.DatabaseURL)
21     if err != nil {
22       log.Fatal("Failed to connect to database:", err)
23     }
24     defer db.Close()
25
26     db.SetMaxOpenConns(25)
27     db.SetMaxIdleConns(5)
28
29     repos := repository.NewRepositories(db)
30     services := &service.Services{
31       Auth:       service.NewAuthService(repos.User, repos.Device,
     cfg.JWTSecret),
32       Route:      service.NewRouteService(repos.Route, repos.Audit),
33       Bus:        service.NewBusService(repos.Bus, repos.Audit),
34       Trip:       service.NewTripService(repos.Trip, repos.Event,
     repos.Analytics, repos.Audit),
35       IoT:        service.NewIoTService(repos.Device, repos.Event,
     repos.Trip, repos.PriceRecommendation),
36       Analytics: service.NewAnalyticsService(repos.Analytics,
     repos.Trip),
37       Forecast: service.NewForecastService(repos.Analytics,
     repos.Route),
38       Settings: service.NewSettingsService(repos.Settings),
                                                                              22

39       Backup:    service.NewBackupService("/app/backups",
     cfg.DatabaseURL),
40       Audit:     service.NewAuditService(repos.Audit),
41     }
42     services.Pricing = service.NewPricingService(services.Settings)
43
44     app := fiber.New(fiber.Config{ErrorHandler:
     handler.CustomErrorHandler})
45     app.Use(logger.New())
46     app.Use(cors.New(cors.Config{
47       AllowOrigins: "*",
48       AllowMethods: "GET,POST,PUT,DELETE,OPTIONS",
49       AllowHeaders: "Origin,Content-Type,Accept,Authorization",
50     }))
51
52       setupRoutes(app, services, repos, cfg)
53
54       port := cfg.Port
55       if port == "" { port = "8080" }
56       log.Printf("Server starting on port %s", port)
57       log.Fatal(app.Listen(":" + port))
58   }


         –í.2 –°–µ—Ä–≤—ñ—Å IoT (iot_service.go)

 1   package service
 2
 3   import (
 4     "busoptima/internal/model"
 5     "busoptima/internal/repository"
 6     "context"
 7     "fmt"
 8     "time"
 9   )
10
11   type IoTService interface {
12     SyncEvents(ctx context.Context, tripID int64, events
     []model.PassengerEvent) (*SyncEventsResponse, error)
13     SendPriceRecommendation(ctx context.Context, recommendation
     *model.PriceRecommendation) error
14     GetTripConfig(ctx context.Context, tripID int64) (*TripConfig, error)
15   }
16
17   type SyncEventsResponse      struct   {
18     SyncedCount                int      `json:"synced_count"`
19     LastSyncedLocalID          int      `json:"last_synced_local_id"`
20     TripCurrentPassengers      int      `json:"trip_current_passengers"`
21     ServerTime                 string   `json:"server_time"`
22   }
23
24   type iotService struct {
25     deviceRepo      repository.DeviceRepository
26     eventRepo       repository.PassengerEventRepository
27     tripRepo        repository.TripRepository
28     priceRecommRepo repository.PriceRecommendationRepository
                                                                              23

29   }
30
31   func (s *iotService) SyncEvents(ctx context.Context, tripID int64,
     events []model.PassengerEvent) (*SyncEventsResponse, error) {
32     if len(events) == 0 {
33       return &SyncEventsResponse{
34         SyncedCount: 0, ServerTime: time.Now().Format(time.RFC3339),
35       }, nil
36     }
37
38       for i := range events {
39         events[i].TripID = tripID
40       }
41
42       err := s.eventRepo.BatchCreate(ctx, events)
43       if err != nil {
44         return nil, fmt.Errorf("failed to sync events: %w", err)
45       }
46
47       trip, _ := s.tripRepo.GetByID(ctx, tripID)
48       lastLocalID := 0
49       if len(events) > 0 && events[len(events)-1].DeviceLocalID != nil {
50         lastLocalID = *events[len(events)-1].DeviceLocalID
51       }
52
53       return &SyncEventsResponse{
54         SyncedCount:           len(events),
55         LastSyncedLocalID:     lastLocalID,
56         TripCurrentPassengers: trip.CurrentPassengers,
57         ServerTime:            time.Now().Format(time.RFC3339),
58       }, nil
59   }
60
61   func (s *iotService) GetTripConfig(ctx context.Context, tripID int64)
     (*TripConfig, error) {
62     trip, err := s.tripRepo.GetByID(ctx, tripID)
63     if err != nil {
64       return nil, fmt.Errorf("failed to get trip: %w", err)
65     }
66
67       config := &TripConfig{TripID: tripID, RouteID: trip.RouteID}
68       if trip.Route != nil { config.BasePrice = trip.Route.BasePrice }
69       if trip.Bus != nil { config.BusCapacity = trip.Bus.Capacity }
70       return config, nil
71   }


         –í.3 –ì–æ–ª–æ–≤–Ω–∏–π –º–æ–¥—É–ª—å IoT –∫–ª—ñ—î–Ω—Ç–∞ (main.cpp)

 1   #include   <Arduino.h>
 2   #include   <WiFi.h>
 3   #include   <time.h>
 4   #include   "config.h"
 5   #include   "models.h"
 6   #include   "event_buffer.h"
 7   #include   "pricing_engine.h"
                                                                             24

 8   #include "api_client.h"
 9   #include "display_manager.h"
10
11   EventBuffer eventBuffer;
12   PricingEngine pricingEngine;
13   ApiClient apiClient;
14   DisplayManager display;
15
16   DeviceState deviceState;
17   TripConfig tripConfig;
18
19   volatile bool entryDetected = false;
20   volatile bool exitDetected = false;
21
22   void IRAM_ATTR onEntryDetected() {
23       unsigned long now = millis();
24       static unsigned long lastTrigger = 0;
25       if (now - lastTrigger > SENSOR_DEBOUNCE_MS) {
26           lastTrigger = now;
27           entryDetected = true;
28       }
29   }
30
31   void IRAM_ATTR onExitDetected() {
32       unsigned long now = millis();
33       static unsigned long lastTrigger = 0;
34       if (now - lastTrigger > SENSOR_DEBOUNCE_MS) {
35           lastTrigger = now;
36           exitDetected = true;
37       }
38   }
39
40   void handlePassengerEntry() {
41       deviceState.currentPassengers++;
42       eventBuffer.addEvent(EVENT_ENTRY, deviceState.currentPassengers);
43       display.showPassengerEvent(EVENT_ENTRY,
     deviceState.currentPassengers);
44   }
45
46   void handlePassengerExit() {
47       if (deviceState.currentPassengers > 0)
     deviceState.currentPassengers--;
48       eventBuffer.addEvent(EVENT_EXIT, deviceState.currentPassengers);
49       display.showPassengerEvent(EVENT_EXIT,
     deviceState.currentPassengers);
50   }
51
52   void setup() {
53       Serial.begin(115200);
54       pinMode(PIN_PIR_ENTRY, INPUT);
55       pinMode(PIN_PIR_EXIT, INPUT);
56       attachInterrupt(digitalPinToInterrupt(PIN_PIR_ENTRY),
     onEntryDetected, RISING);
57       attachInterrupt(digitalPinToInterrupt(PIN_PIR_EXIT),
     onExitDetected, RISING);
58
                                                                             25

59         display.begin();
60         eventBuffer.begin();
61
62         WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
63         while (WiFi.status() != WL_CONNECTED) {
64             digitalWrite(PIN_LED_WIFI, !digitalRead(PIN_LED_WIFI));
65             delay(500);
66         }
67         digitalWrite(PIN_LED_WIFI, HIGH);
68         configTime(2 * 3600, 0, "pool.ntp.org");
69   }
70
71   void loop() {
72       if (entryDetected) { entryDetected = false;
     handlePassengerEntry(); }
73       if (exitDetected) { exitDetected = false; handlePassengerExit(); }
74       delay(10);
75   }


         –í.4 –†—É—à—ñ–π –¥–∏–Ω–∞–º—ñ—á–Ω–æ–≥–æ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è IoT (pricing_engine.h)

 1   #ifndef PRICING_ENGINE_H
 2   #define PRICING_ENGINE_H
 3
 4   #include "config.h"
 5   #include "models.h"
 6
 7   class PricingEngine {
 8   private:
 9       float calculateDemandCoefficient(float occupancyRate) {
10            if (occupancyRate < 30.0) return DEMAND_COEFF_LOW;
11            if (occupancyRate < 60.0) return DEMAND_COEFF_MEDIUM;
12            if (occupancyRate < 85.0) return DEMAND_COEFF_HIGH;
13            return DEMAND_COEFF_VERY_HIGH;
14       }
15
16         float calculateTimeCoefficient(int hour) {
17             if ((hour >= 7 && hour <= 9) || (hour >= 17 && hour <= 19))
18                 return TIME_COEFF_PEAK;
19             if (hour >= 23 || hour <= 6)
20                 return TIME_COEFF_NIGHT;
21             return TIME_COEFF_NORMAL;
22         }
23
24       float calculateDayCoefficient(int dayOfWeek) {
25           return (dayOfWeek == 0 || dayOfWeek == 6) ? DAY_COEFF_WEEKEND :
     DAY_COEFF_WEEKDAY;
26       }
27
28   public:
29       PriceRecommendation calculatePrice(float basePrice, int
     currentPassengers,
30                                           int capacity, struct tm*
     timeinfo) {
31           PriceRecommendation rec;
                                                                             26

32           rec.basePrice = basePrice;
33           rec.occupancyRate = (capacity > 0) ? (float)currentPassengers /
     capacity * 100.0 : 0.0;
34
35           rec.demandCoeff =
     calculateDemandCoefficient(rec.occupancyRate);
36           rec.timeCoeff = calculateTimeCoefficient(timeinfo ? timeinfo-
     >tm_hour : 12);
37           rec.dayCoeff = calculateDayCoefficient(timeinfo ? timeinfo-
     >tm_wday : 1);
38
39           float rawPrice = basePrice * rec.demandCoeff * rec.timeCoeff *
     rec.dayCoeff;
40           rawPrice = constrain(rawPrice, basePrice * PRICE_MIN_COEFF,
     basePrice * PRICE_MAX_COEFF);
41           rec.recommendedPrice = round(rawPrice / PRICE_ROUND_STEP) *
     PRICE_ROUND_STEP;
42
43            return rec;
44        }
45   };
46
47   #endif


      –í.5 –ï–∫—Å–ø–æ—Ä—Ç/—ñ–º–ø–æ—Ä—Ç –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å (settings_service.go)

 1 // ExportSettings –µ–∫—Å–ø–æ—Ä—Ç—É—î –ø–æ—Ç–æ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON
 2 func (s *settingsService) ExportSettings(ctx context.Context)
   (*SettingsExport, error) {
 3   settings, err := s.GetSettings(ctx)
 4   if err != nil {
 5      return nil, fmt.Errorf("failed to get settings for export: %w",
   err)
 6   }
 7
 8   return &SettingsExport{
 9      Version:    "1.0",
10      ExportedAt: time.Now().Format(time.RFC3339),
11      Settings:   settings,
12   }, nil
13 }
14
15 // ImportSettings —ñ–º–ø–æ—Ä—Ç—É—î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É
16 func (s *settingsService) ImportSettings(ctx context.Context, export
   *SettingsExport, userID int64) error {
17   if export == nil || export.Settings == nil {
18      return fmt.Errorf("invalid export data: settings are empty")
19   }
20
21   if export.Version != "1.0" {
22      return fmt.Errorf("unsupported export version: %s", export.Version)
23   }
24
25   if err := s.ValidateSettings(export.Settings); err != nil {
26      return fmt.Errorf("imported settings validation failed: %w", err)
                                                                 27

27       }
28
29       return s.UpdateSettings(ctx, export.Settings, userID)
30   }
